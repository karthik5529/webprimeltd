<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöú Farm Paradise - Ultimate Farming Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.5s ease;
            overflow-x: hidden;
            user-select: none;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
        }

        body.night {
            background: linear-gradient(135deg, #191970 0%, #2F4F4F 50%, #483D8B 100%);
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        body.night .header {
            background: rgba(0, 0, 0, 0.7);
            color: white;
        }

        .player-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        .resources {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 25px;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }

        .level-bar {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .level-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Game Area */
        .game-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .game-area {
                grid-template-columns: 2fr 1fr;
            }
        }

        .farming-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        body.night .farming-section {
            background: rgba(0, 0, 0, 0.6);
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #2E7D32;
        }

        body.night .section-title {
            color: #4CAF50;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        /* Farm Grid */
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .plot {
            aspect-ratio: 1;
            border: 3px dashed #8BC34A;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: #F1F8E9;
        }

        body.night .plot {
            background: #2E3B2E;
            border-color: #66BB6A;
        }

        .plot:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
        }

        .plot.planted {
            background: #E8F5E8;
            border-color: #4CAF50;
        }

        body.night .plot.planted {
            background: #1B2E1B;
        }

        .plot.ready {
            background: #FFE0B2;
            border-color: #FF9800;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 152, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 152, 0, 0.8); }
        }

        .crop-icon {
            font-size: 30px;
            margin-bottom: 5px;
            animation: grow 2s infinite;
        }

        @keyframes grow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .timer {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        body.night .timer {
            color: #ccc;
        }

        /* Animal Farm */
        .animal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .animal-pen {
            aspect-ratio: 1;
            border: 3px solid #8D6E63;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: #FFF3E0;
        }

        body.night .animal-pen {
            background: #3E2723;
            border-color: #A1887F;
        }

        .animal-pen:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(141, 110, 99, 0.3);
        }

        .animal-pen.occupied {
            background: #E3F2FD;
            border-color: #2196F3;
        }

        body.night .animal-pen.occupied {
            background: #1A237E;
        }

        .animal-icon {
            font-size: 35px;
            margin-bottom: 5px;
            animation: bounce 3s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .status-icons {
            display: flex;
            gap: 5px;
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .status-icon {
            font-size: 16px;
            padding: 2px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
        }

        /* Store */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .store-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        body.night .store-item {
            background: rgba(255, 255, 255, 0.1);
        }

        .store-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: #4CAF50;
        }

        .item-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-price {
            color: #FF9800;
            font-weight: bold;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        body.night .modal-content {
            background: #333;
            color: white;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6);
        }

        /* Popup */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            max-width: 90vw;
            text-align: center;
            display: none;
        }

        body.night .popup {
            background: #333;
            color: white;
        }

        .popup.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .popup h3 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #ccc;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Floating Numbers */
        .floating-number {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            animation: float 2s ease-out forwards;
            z-index: 10;
        }

        @keyframes float {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .player-info, .resources {
                justify-content: center;
            }

            .level-bar {
                width: 150px;
            }

            .farm-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }

            .animal-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .store-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .fab {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }
        }

        /* Achievements */
        .achievement-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .achievement-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .achievement-item.completed {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4CAF50;
        }

        .achievement-icon {
            font-size: 30px;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-reward {
            background: #FF9800;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .achievement-reward.claimed {
            background: #ccc;
            cursor: default;
        }

        /* Inventory */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .inventory-icon {
            font-size: 35px;
            margin-bottom: 10px;
        }

        .inventory-count {
            font-weight: bold;
            color: #4CAF50;
        }

        /* Daily Quest */
        .quest-item {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .quest-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .quest-progress-bar {
            height: 100%;
            background: #FFD700;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Weather System */
        .weather-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body.night .weather-indicator {
            background: rgba(0, 0, 0, 0.7);
            color: white;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #FFD700;
            animation: confetti-fall 3s linear forwards;
            z-index: 1500;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Weather Indicator -->
    <div class="weather-indicator">
        <span id="weather-icon">‚òÄÔ∏è</span>
        <span id="weather-text">Sunny</span>
    </div>

    <!-- Header -->
    <div class="container">
        <div class="header">
            <div class="player-info">
                <h2 id="player-name">Farmer</h2>
                <span id="player-badge" class="badge">Bronze</span>
                <div class="level-bar">
                    <div id="level-progress" class="level-progress" style="width: 0%"></div>
                </div>
                <span id="level-text">Level 1</span>
            </div>
            <div class="resources">
                <div class="resource">
                    <span>üí∞</span>
                    <span id="coins">100</span>
                </div>
                <div class="resource">
                    <span>üíé</span>
                    <span id="diamonds">5</span>
                </div>
                <div class="resource">
                    <span>‚ö°</span>
                    <span id="energy">100</span>
                </div>
                <div class="resource">
                    <span>üéØ</span>
                    <span id="combo">0x</span>
                </div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div class="farming-section">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('crops')">üåæ Crops</div>
                    <div class="tab" onclick="switchTab('animals')">üêÑ Animals</div>
                    <div class="tab" onclick="switchTab('store')">üõí Store</div>
                </div>

                <!-- Crops Tab -->
                <div id="crops-tab" class="tab-content">
                    <h3 class="section-title">üöú Your Farm</h3>
                    <div id="crop-grid" class="farm-grid">
                        <!-- Crop plots will be generated here -->
                    </div>
                    <button class="btn btn-primary" onclick="showSeedSelector()">üå± Plant Seeds</button>
                </div>

                <!-- Animals Tab -->
                <div id="animals-tab" class="tab-content" style="display: none;">
                    <h3 class="section-title">üêÑ Animal Farm</h3>
                    <div id="animal-grid" class="animal-grid">
                        <!-- Animal pens will be generated here -->
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="showAnimalMarket()">üè™ Buy Animals</button>
                        <button class="btn btn-secondary" onclick="feedAllAnimals()">üåæ Feed All</button>
                        <button class="btn btn-secondary" onclick="healAllAnimals()">üíä Heal All</button>
                    </div>
                </div>

                <!-- Store Tab -->
                <div id="store-tab" class="tab-content" style="display: none;">
                    <h3 class="section-title">üõí Farm Store</h3>
                    <div class="tabs">
                        <div class="tab active" onclick="switchStoreTab('seeds')">üå± Seeds</div>
                        <div class="tab" onclick="switchStoreTab('upgrades')">‚ö° Upgrades</div>
                        <div class="tab" onclick="switchStoreTab('supplies')">üì¶ Supplies</div>
                    </div>
                    <div id="store-content" class="store-grid">
                        <!-- Store items will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="farming-section">
                <h3 class="section-title">üìä Farm Stats</h3>
                
                <!-- Daily Quest -->
                <div id="daily-quest" class="quest-item">
                    <h4>üéØ Daily Quest</h4>
                    <p id="quest-text">Harvest 5 crops</p>
                    <div class="quest-progress">
                        <div id="quest-progress-bar" class="quest-progress-bar" style="width: 0%"></div>
                    </div>
                    <button id="claim-quest" class="btn btn-primary" onclick="claimQuestReward()" style="margin-top: 10px; display: none;">Claim Reward</button>
                </div>

                <!-- Power-ups -->
                <div style="margin: 20px 0;">
                    <h4>‚ö° Active Boosts</h4>
                    <div id="active-boosts">
                        <!-- Active boosts will be shown here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" onclick="showInventory()">üì¶ Inventory</button>
                    <button class="btn btn-primary" onclick="showAchievements()">üèÜ Achievements</button>
                    <button class="btn btn-primary" onclick="showProfile()">üë§ Profile</button>
                    <button class="btn btn-secondary" onclick="collectAllReady()">üåæ Harvest All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickActions()">‚ö°</button>

    <!-- Popup -->
    <div id="popup" class="popup">
        <h3 id="popup-title"></h3>
        <p id="popup-message"></p>
        <div class="popup-buttons">
            <button id="popup-confirm" class="btn btn-primary" onclick="hidePopup()">OK</button>
            <button id="popup-cancel" class="btn btn-secondary" onclick="hidePopup()" style="display: none;">Cancel</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="inventory-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('inventory-modal')">&times;</span>
            <h2>üì¶ Inventory</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchInventoryTab('crops')">üåæ Crops</div>
                <div class="tab" onclick="switchInventoryTab('animals')">ü•õ Animal Products</div>
                <div class="tab" onclick="switchInventoryTab('seeds')">üå± Seeds</div>
            </div>
            <div id="inventory-content" class="inventory-grid">
                <!-- Inventory items will be generated here -->
            </div>
        </div>
    </div>

    <div id="achievements-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('achievements-modal')">&times;</span>
            <h2>üèÜ Achievements</h2>
            <div id="achievements-content">
                <!-- Achievements will be generated here -->
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profile-modal')">&times;</span>
            <h2>üë§ Player Profile</h2>
            <div id="profile-content">
                <!-- Profile content will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameData = {
            player: {
                name: 'Farmer',
                level: 1,
                xp: 0,
                coins: 100,
                diamonds: 5,
                energy: 100,
                maxEnergy: 100,
                loginStreak: 1,
                lastLogin: Date.now(),
                totalPlayTime: 0,
                sessionStartTime: Date.now()
            },
            crops: [],
            animals: [],
            inventory: {
                crops: {},
                seeds: { wheat: 5, tomato: 3, corn: 2, rice: 1 },
                animalProducts: {},
                supplies: { feed: 10, medicine: 2 }
            },
            landPlots: 4,
            animalPens: 2,
            upgrades: {
                growthSpeed: 1,
                yieldMultiplier: 1,
                autoHarvest: false,
                autoFeed: false,
                weatherResistance: false
            },
            achievements: {},
            dailyQuest: {
                type: 'harvest',
                target: 5,
                progress: 0,
                claimed: false,
                lastReset: Date.now()
            },
            weather: 'sunny',
            boosts: {
                doubleCoins: 0,
                fastGrowth: 0,
                luckyChance: 0
            },
            comboMultiplier: 1,
            comboCount: 0,
            lastAction: 0,
            harvestStreak: 0
        };

        // Game Data
        const cropTypes = {
            wheat: { name: 'Wheat', icon: 'üåæ', growTime: 30000, baseValue: 10, seedCost: 5 },
            tomato: { name: 'Tomato', icon: 'üçÖ', growTime: 45000, baseValue: 15, seedCost: 8 },
            corn: { name: 'Corn', icon: 'üåΩ', growTime: 60000, baseValue: 20, seedCost: 12 },
            rice: { name: 'Rice', icon: 'üåæ', growTime: 90000, baseValue: 25, seedCost: 15 },
            carrot: { name: 'Carrot', icon: 'ü•ï', growTime: 35000, baseValue: 12, seedCost: 6 },
            potato: { name: 'Potato', icon: 'ü•î', growTime: 50000, baseValue: 18, seedCost: 10 },
            pumpkin: { name: 'Pumpkin', icon: 'üéÉ', growTime: 120000, baseValue: 35, seedCost: 25 },
            strawberry: { name: 'Strawberry', icon: 'üçì', growTime: 40000, baseValue: 16, seedCost: 9 },
            eggplant: { name: 'Eggplant', icon: 'üçÜ', growTime: 55000, baseValue: 22, seedCost: 14 },
            broccoli: { name: 'Broccoli', icon: 'ü•¶', growTime: 65000, baseValue: 24, seedCost: 16 }
        };

        const animalTypes = {
            hen: { name: 'Hen', icon: 'üêî', cost: 50, product: 'egg', productTime: 60000, productIcon: 'ü•ö' },
            cow: { name: 'Cow', icon: 'üêÑ', cost: 200, product: 'milk', productTime: 120000, productIcon: 'ü•õ' },
            goat: { name: 'Goat', icon: 'üêê', cost: 150, product: 'milk', productTime: 90000, productIcon: 'ü•õ' },
            sheep: { name: 'Sheep', icon: 'üêë', cost: 180, product: 'wool', productTime: 180000, productIcon: 'üß∂' },
            horse: { name: 'Horse', icon: 'üêé', cost: 500, product: null, productTime: 0, productIcon: '' }
        };

        const achievements = {
            firstHarvest: { name: 'First Harvest', icon: 'üå±', desc: 'Harvest your first crop', reward: 5, type: 'diamonds' },
            harvester: { name: 'Harvester', icon: 'üåæ', desc: 'Harvest 50 crops', reward: 10, type: 'diamonds', target: 50 },
            animalLover: { name: 'Animal Lover', icon: 'üêÑ', desc: 'Own 5 animals', reward: 15, type: 'diamonds', target: 5 },
            millionaire: { name: 'Millionaire', icon: 'üí∞', desc: 'Earn 1000 coins', reward: 20, type: 'diamonds', target: 1000 },
            speedFarmer: { name: 'Speed Farmer', icon: '‚ö°', desc: 'Complete 10 harvests in a row quickly', reward: 25, type: 'diamonds', target: 10 }
        };

        // Utility Functions
        function saveGame() {
            localStorage.setItem('farmGameData', JSON.stringify(gameData));
        }

        function loadGame() {
            const saved = localStorage.getItem('farmGameData');
            if (saved) {
                const loadedData = JSON.parse(saved);
                gameData = { ...gameData, ...loadedData };
                
                // Check for ready crops/animals while away
                checkProgressWhileAway();
            }
            
            // Reset daily quest if needed
            resetDailyQuestIfNeeded();
            updateUI();
        }

        function checkProgressWhileAway() {
            const now = Date.now();
            let readyItems = [];

            // Check crops
            gameData.crops.forEach(crop => {
                if (crop.plantTime && now >= crop.plantTime + crop.growTime) {
                    readyItems.push(`${cropTypes[crop.type].name} is ready to harvest! ${cropTypes[crop.type].icon}`);
                }
            });

            // Check animals
            gameData.animals.forEach(animal => {
                if (animal.lastProduct && animalTypes[animal.type].productTime > 0) {
                    const timeSinceProduct = now - animal.lastProduct;
                    if (timeSinceProduct >= animalTypes[animal.type].productTime) {
                        readyItems.push(`${animalTypes[animal.type].name} has produced ${animalTypes[animal.type].productIcon}!`);
                    }
                }
            });

            if (readyItems.length > 0) {
                showPopup('Welcome Back!', `üéâ Welcome back, ${gameData.player.name}!\n\n${readyItems.join('\n')}`);
            }
        }

        function resetDailyQuestIfNeeded() {
            const now = Date.now();
            const lastReset = gameData.dailyQuest.lastReset;
            const oneDayMs = 24 * 60 * 60 * 1000;

            if (now - lastReset >= oneDayMs) {
                const quests = [
                    { type: 'harvest', target: 5, desc: 'Harvest 5 crops' },
                    { type: 'plant', target: 10, desc: 'Plant 10 seeds' },
                    { type: 'collect', target: 3, desc: 'Collect 3 animal products' },
                    { type: 'earn', target: 100, desc: 'Earn 100 coins' }
                ];
                
                const randomQuest = quests[Math.floor(Math.random() * quests.length)];
                gameData.dailyQuest = {
                    ...randomQuest,
                    progress: 0,
                    claimed: false,
                    lastReset: now
                };
            }
        }

        function updateUI() {
            // Update header
            document.getElementById('player-name').textContent = gameData.player.name;
            document.getElementById('coins').textContent = gameData.player.coins;
            document.getElementById('diamonds').textContent = gameData.player.diamonds;
            document.getElementById('energy').textContent = gameData.player.energy;
            document.getElementById('combo').textContent = `${gameData.comboCount}x`;
            
            // Update level and badge
            const badge = getBadge(gameData.player.xp);
            document.getElementById('player-badge').textContent = badge;
            document.getElementById('player-badge').className = `badge badge-${badge.toLowerCase()}`;
            
            const level = Math.floor(gameData.player.xp / 100) + 1;
            gameData.player.level = level;
            document.getElementById('level-text').textContent = `Level ${level}`;
            
            const xpInLevel = gameData.player.xp % 100;
            document.getElementById('level-progress').style.width = `${xpInLevel}%`;

            // Update day/night theme
            updateDayNightTheme();
            
            // Update weather
            updateWeather();
            
            // Update daily quest
            updateDailyQuest();
            
            // Update active boosts
            updateActiveBoosts();
            
            // Generate farm areas
            generateCropGrid();
            generateAnimalGrid();
        }

        function updateDayNightTheme() {
            const hour = new Date().getHours();
            const isNight = hour < 6 || hour >= 18;
            
            if (isNight) {
                document.body.classList.add('night');
            } else {
                document.body.classList.remove('night');
            }
        }

        function updateWeather() {
            const weathers = [
                { type: 'sunny', icon: '‚òÄÔ∏è', text: 'Sunny', boost: 'normal' },
                { type: 'rainy', icon: 'üåßÔ∏è', text: 'Rainy', boost: 'growth' },
                { type: 'cloudy', icon: '‚òÅÔ∏è', text: 'Cloudy', boost: 'normal' },
                { type: 'windy', icon: 'üí®', text: 'Windy', boost: 'coins' }
            ];

            // Change weather randomly every 5 minutes
            if (Math.random() < 0.1) {
                gameData.weather = weathers[Math.floor(Math.random() * weathers.length)].type;
            }

            const currentWeather = weathers.find(w => w.type === gameData.weather) || weathers[0];
            document.getElementById('weather-icon').textContent = currentWeather.icon;
            document.getElementById('weather-text').textContent = currentWeather.text;
        }

        function updateDailyQuest() {
            const quest = gameData.dailyQuest;
            document.getElementById('quest-text').textContent = quest.desc;
            
            const progress = Math.min(quest.progress / quest.target * 100, 100);
            document.getElementById('quest-progress-bar').style.width = `${progress}%`;
            
            const claimButton = document.getElementById('claim-quest');
            if (quest.progress >= quest.target && !quest.claimed) {
                claimButton.style.display = 'block';
            } else {
                claimButton.style.display = 'none';
            }
        }

        function updateActiveBoosts() {
            const boostsContainer = document.getElementById('active-boosts');
            boostsContainer.innerHTML = '';

            Object.keys(gameData.boosts).forEach(boostType => {
                const timeLeft = gameData.boosts[boostType];
                if (timeLeft > 0) {
                    const boostElement = document.createElement('div');
                    boostElement.className = 'boost-item';
                    boostElement.innerHTML = `
                        <span>${getBoostIcon(boostType)} ${getBoostName(boostType)}</span>
                        <span>${Math.ceil(timeLeft / 1000)}s</span>
                    `;
                    boostsContainer.appendChild(boostElement);
                }
            });

            if (boostsContainer.children.length === 0) {
                boostsContainer.innerHTML = '<p style="color: #999;">No active boosts</p>';
            }
        }

        function getBoostIcon(boostType) {
            const icons = {
                doubleCoins: 'üí∞',
                fastGrowth: '‚ö°',
                luckyChance: 'üçÄ'
            };
            return icons[boostType] || '‚ö°';
        }

        function getBoostName(boostType) {
            const names = {
                doubleCoins: 'Double Coins',
                fastGrowth: 'Fast Growth',
                luckyChance: 'Lucky Chance'
            };
            return names[boostType] || boostType;
        }

        function getBadge(xp) {
            if (xp >= 1200) return 'Master Legend';
            if (xp >= 700) return 'Master';
            if (xp >= 400) return 'Crystal';
            if (xp >= 200) return 'Gold';
            if (xp >= 100) return 'Silver';
            return 'Bronze';
        }

        function generateCropGrid() {
            const grid = document.getElementById('crop-grid');
            grid.innerHTML = '';

            for (let i = 0; i < gameData.landPlots; i++) {
                const plot = document.createElement('div');
                plot.className = 'plot';
                plot.dataset.index = i;

                const crop = gameData.crops[i];
                if (crop) {
                    const now = Date.now();
                    const isReady = now >= crop.plantTime + crop.growTime;
                    
                    plot.classList.add(isReady ? 'ready' : 'planted');
                    plot.innerHTML = `
                        <div class="crop-icon">${cropTypes[crop.type].icon}</div>
                        <div class="timer">${isReady ? 'Ready!' : formatTime((crop.plantTime + crop.growTime) - now)}</div>
                    `;
                    
                    if (isReady) {
                        plot.onclick = () => harvestCrop(i);
                    }
                } else {
                    plot.innerHTML = `
                        <div style="color: #999;">Empty Plot</div>
                        <div style="font-size: 12px;">Click to plant</div>
                    `;
                    plot.onclick = () => showSeedSelector(i);
                }

                grid.appendChild(plot);
            }
        }

        function generateAnimalGrid() {
            const grid = document.getElementById('animal-grid');
            grid.innerHTML = '';

            for (let i = 0; i < gameData.animalPens; i++) {
                const pen = document.createElement('div');
                pen.className = 'animal-pen';
                pen.dataset.index = i;

                const animal = gameData.animals[i];
                if (animal) {
                    pen.classList.add('occupied');
                    
                    const statusIcons = [];
                    if (animal.needsFood) statusIcons.push('<span class="status-icon" style="background: #f44336;">üçΩÔ∏è</span>');
                    if (animal.sick) statusIcons.push('<span class="status-icon" style="background: #ff9800;">üè•</span>');
                    if (animal.canProduce) statusIcons.push('<span class="status-icon" style="background: #4caf50;">‚ú®</span>');

                    pen.innerHTML = `
                        <div class="animal-icon">${animalTypes[animal.type].icon}</div>
                        <div class="timer">${animal.name || animalTypes[animal.type].name}</div>
                        <div class="status-icons">${statusIcons.join('')}</div>
                    `;
                    
                    pen.onclick = () => interactWithAnimal(i);
                } else {
                    pen.innerHTML = `
                        <div style="color: #999;">Empty Pen</div>
                        <div style="font-size: 12px;">Buy animal</div>
                    `;
                    pen.onclick = () => showAnimalMarket(i);
                }

                grid.appendChild(pen);
            }
        }

        function formatTime(ms) {
            if (ms <= 0) return 'Ready!';
            const seconds = Math.ceil(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            if (minutes > 0) {
                return `${minutes}m ${remainingSeconds}s`;
            }
            return `${remainingSeconds}s`;
        }

        function showSeedSelector(plotIndex = null) {
            const availableSeeds = Object.keys(gameData.inventory.seeds).filter(seed => gameData.inventory.seeds[seed] > 0);
            
            if (availableSeeds.length === 0) {
                showPopup('No Seeds', 'You need to buy seeds from the store first!');
                return;
            }

            let content = '<h3>üå± Select Seed to Plant</h3><div class="store-grid">';
            
            availableSeeds.forEach(seedType => {
                const crop = cropTypes[seedType];
                const count = gameData.inventory.seeds[seedType];
                
                content += `
                    <div class="store-item" onclick="plantSeed('${seedType}', ${plotIndex})">
                        <div class="item-icon">${crop.icon}</div>
                        <div class="item-name">${crop.name}</div>
                        <div class="item-price">Stock: ${count}</div>
                        <div style="font-size: 12px;">Grow time: ${formatTime(crop.growTime)}</div>
                    </div>
                `;
            });
            
            content += '</div>';
            
            showCustomModal('seed-selector', content);
        }

        function plantSeed(seedType, plotIndex = null) {
            if (gameData.player.energy < 10) {
                showPopup('Not Enough Energy', 'You need at least 10 energy to plant seeds!');
                return;
            }

            if (gameData.inventory.seeds[seedType] <= 0) {
                showPopup('No Seeds', `You don't have any ${cropTypes[seedType].name} seeds!`);
                return;
            }

            let targetPlot = plotIndex;
            if (targetPlot === null) {
                // Find first empty plot
                targetPlot = gameData.crops.findIndex(crop => !crop);
                if (targetPlot === -1) {
                    targetPlot = gameData.crops.length;
                    if (targetPlot >= gameData.landPlots) {
                        showPopup('No Empty Plots', 'All your plots are occupied. Harvest some crops first!');
                        return;
                    }
                }
            }

            // Plant the seed
            gameData.crops[targetPlot] = {
                type: seedType,
                plantTime: Date.now(),
                growTime: cropTypes[seedType].growTime * (gameData.boosts.fastGrowth > 0 ? 0.5 : 1)
            };

            // Update inventory and energy
            gameData.inventory.seeds[seedType]--;
            gameData.player.energy -= 10;

            // Update quest progress
            if (gameData.dailyQuest.type === 'plant') {
                gameData.dailyQuest.progress++;
            }

            // Add XP
            addXP(2);

            closeModal('custom-modal');
            updateUI();
            saveGame();

            showFloatingNumber('+2 XP', document.querySelector(`[data-index="${targetPlot}"]`));
            updateCombo();
        }

        function harvestCrop(plotIndex) {
            const crop = gameData.crops[plotIndex];
            if (!crop) return;

            const now = Date.now();
            if (now < crop.plantTime + crop.growTime) {
                showPopup('Not Ready', 'This crop is still growing!');
                return;
            }

            const cropType = cropTypes[crop.type];
            let coinsEarned = cropType.baseValue * gameData.upgrades.yieldMultiplier;
            
            // Apply weather bonus
            if (gameData.weather === 'windy') {
                coinsEarned *= 1.5;
            }

            // Apply combo multiplier
            coinsEarned = Math.floor(coinsEarned * gameData.comboMultiplier);

            // Apply double coins boost
            if (gameData.boosts.doubleCoins > 0) {
                coinsEarned *= 2;
            }

            // Add to inventory
            if (!gameData.inventory.crops[crop.type]) {
                gameData.inventory.crops[crop.type] = 0;
            }
            gameData.inventory.crops[crop.type]++;

            // Add coins
            gameData.player.coins += coinsEarned;

            // Chance for diamonds
            if (Math.random() < 0.1 * (gameData.boosts.luckyChance > 0 ? 2 : 1)) {
                gameData.player.diamonds++;
                showFloatingNumber('+1 üíé', document.querySelector(`[data-index="${plotIndex}"]`));
            }

            // Add XP
            addXP(5);

            // Update quest progress
            if (gameData.dailyQuest.type === 'harvest') {
                gameData.dailyQuest.progress++;
            }

            // Update achievements
            updateAchievement('firstHarvest');
            updateAchievement('harvester');

            // Clear the plot
            gameData.crops[plotIndex] = null;

            updateUI();
            saveGame();

            showFloatingNumber(`+${coinsEarned} üí∞`, document.querySelector(`[data-index="${plotIndex}"]`));
            showFloatingNumber('+5 XP', document.querySelector(`[data-index="${plotIndex}"]`));
            
            updateCombo();
            gameData.harvestStreak++;
            
            // Check for speed farmer achievement
            if (gameData.harvestStreak >= 10) {
                updateAchievement('speedFarmer');
            }
        }

        function showAnimalMarket(penIndex = null) {
            let content = '<h3>üè™ Animal Market</h3><div class="store-grid">';
            
            Object.keys(animalTypes).forEach(animalType => {
                const animal = animalTypes[animalType];
                
                content += `
                    <div class="store-item" onclick="buyAnimal('${animalType}', ${penIndex})">
                        <div class="item-icon">${animal.icon}</div>
                        <div class="item-name">${animal.name}</div>
                        <div class="item-price">üí∞ ${animal.cost}</div>
                        <div style="font-size: 12px;">
                            ${animal.product ? `Produces: ${animal.productIcon}` : 'Special: Racing & Transport'}
                        </div>
                    </div>
                `;
            });
            
            content += '</div>';
            
            showCustomModal('animal-market', content);
        }

        function buyAnimal(animalType, penIndex = null) {
            const animal = animalTypes[animalType];
            
            if (gameData.player.coins < animal.cost) {
                showPopup('Not Enough Coins', `You need ${animal.cost} coins to buy a ${animal.name}!`);
                return;
            }

            let targetPen = penIndex;
            if (targetPen === null) {
                // Find first empty pen
                targetPen = gameData.animals.findIndex(animal => !animal);
                if (targetPen === -1) {
                    targetPen = gameData.animals.length;
                    if (targetPen >= gameData.animalPens) {
                        showPopup('No Empty Pens', 'All your pens are occupied. Upgrade your farm first!');
                        return;
                    }
                }
            }

            // Buy the animal
            gameData.animals[targetPen] = {
                type: animalType,
                name: animal.name,
                health: 100,
                happiness: 100,
                lastFed: Date.now(),
                lastProduct: Date.now(),
                needsFood: false,
                sick: false,
                canProduce: true
            };

            gameData.player.coins -= animal.cost;

            // Update achievements
            updateAchievement('animalLover');

            closeModal('custom-modal');
            updateUI();
            saveGame();

            showPopup('Animal Purchased!', `You bought a ${animal.name}! üéâ`);
        }

        function interactWithAnimal(penIndex) {
            const animal = gameData.animals[penIndex];
            if (!animal) return;

            const animalType = animalTypes[animal.type];
            
            // Check if can produce
            if (animalType.product && animal.canProduce) {
                const now = Date.now();
                if (now >= animal.lastProduct + animalType.productTime) {
                    // Collect product
                    const product = animalType.product;
                    if (!gameData.inventory.animalProducts[product]) {
                        gameData.inventory.animalProducts[product] = 0;
                    }
                    gameData.inventory.animalProducts[product]++;
                    
                    animal.lastProduct = now;
                    animal.canProduce = false;
                    
                    // Restore production after some time
                    setTimeout(() => {
                        if (gameData.animals[penIndex]) {
                            gameData.animals[penIndex].canProduce = true;
                            updateUI();
                        }
                    }, animalType.productTime);

                    // Add coins
                    const coinsEarned = 15;
                    gameData.player.coins += coinsEarned;

                    // Update quest progress
                    if (gameData.dailyQuest.type === 'collect') {
                        gameData.dailyQuest.progress++;
                    }

                    // Add XP
                    addXP(3);

                    updateUI();
                    saveGame();

                    showFloatingNumber(`+${coinsEarned} üí∞`, document.querySelector(`[data-index="${penIndex}"]`));
                    showFloatingNumber('+3 XP', document.querySelector(`[data-index="${penIndex}"]`));
                    showPopup('Product Collected!', `You collected ${animalType.productIcon} from your ${animalType.name}!`);
                    return;
                }
            }

            // Pet animal for bonus coins
            if (Math.random() < 0.3) {
                const bonusCoins = Math.floor(Math.random() * 10) + 5;
                gameData.player.coins += bonusCoins;
                animal.happiness = Math.min(animal.happiness + 10, 100);
                
                updateUI();
                saveGame();
                
                showFloatingNumber(`+${bonusCoins} üí∞`, document.querySelector(`[data-index="${penIndex}"]`));
                showPopup('Animal Happy!', `${animal.name} is happy and gave you bonus coins! üéâ`);
            } else {
                showPopup('Animal Info', `This is your ${animalType.name}.\nHealth: ${animal.health}%\nHappiness: ${animal.happiness}%`);
            }
        }

        function feedAllAnimals() {
            const feedCost = gameData.animals.filter(a => a).length * 2;
            
            if (gameData.inventory.supplies.feed < feedCost) {
                showPopup('Not Enough Feed', `You need ${feedCost} feed to feed all animals!`);
                return;
            }

            gameData.animals.forEach(animal => {
                if (animal) {
                    animal.lastFed = Date.now();
                    animal.needsFood = false;
                    animal.health = Math.min(animal.health + 10, 100);
                    animal.happiness = Math.min(animal.happiness + 5, 100);
                }
            });

            gameData.inventory.supplies.feed -= feedCost;
            
            updateUI();
            saveGame();
            
            showPopup('Animals Fed!', 'All your animals have been fed! üåæ');
        }

        function healAllAnimals() {
            const sickAnimals = gameData.animals.filter(a => a && a.sick);
            const medicineCost = sickAnimals.length;
            
            if (medicineCost === 0) {
                showPopup('No Sick Animals', 'All your animals are healthy! üí™');
                return;
            }

            if (gameData.inventory.supplies.medicine < medicineCost) {
                showPopup('Not Enough Medicine', `You need ${medicineCost} medicine to heal all sick animals!`);
                return;
            }

            sickAnimals.forEach(animal => {
                animal.sick = false;
                animal.health = 100;
                animal.canProduce = true;
            });

            gameData.inventory.supplies.medicine -= medicineCost;
            
            updateUI();
            saveGame();
            
            showPopup('Animals Healed!', 'All sick animals have been healed! üíä');
        }

        function addXP(amount) {
            const oldLevel = gameData.player.level;
            gameData.player.xp += amount;
            const newLevel = Math.floor(gameData.player.xp / 100) + 1;
            
            if (newLevel > oldLevel) {
                // Level up!
                gameData.player.level = newLevel;
                gameData.player.diamonds += 5;
                gameData.landPlots++;
                
                showLevelUpEffect();
                showPopup('Level Up!', `üéâ Congratulations! You reached level ${newLevel}!\n\n+5 üíé Diamonds\n+1 üå± Land Plot`);
            }
        }

        function showLevelUpEffect() {
            // Create confetti
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1'][Math.floor(Math.random() * 4)];
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        function updateCombo() {
            const now = Date.now();
            if (now - gameData.lastAction < 5000) {
                gameData.comboCount++;
                gameData.comboMultiplier = 1 + (gameData.comboCount * 0.1);
            } else {
                gameData.comboCount = 1;
                gameData.comboMultiplier = 1;
            }
            
            gameData.lastAction = now;
            
            // Reset combo after 5 seconds
            setTimeout(() => {
                if (Date.now() - gameData.lastAction >= 5000) {
                    gameData.comboCount = 0;
                    gameData.comboMultiplier = 1;
                    updateUI();
                }
            }, 5000);
        }

        function updateAchievement(achievementId) {
            const achievement = achievements[achievementId];
            if (!achievement || gameData.achievements[achievementId]?.completed) return;

            if (!gameData.achievements[achievementId]) {
                gameData.achievements[achievementId] = { progress: 0, completed: false, claimed: false };
            }

            const ach = gameData.achievements[achievementId];
            
            switch (achievementId) {
                case 'firstHarvest':
                    ach.progress = 1;
                    break;
                case 'harvester':
                    ach.progress = Object.values(gameData.inventory.crops).reduce((sum, count) => sum + count, 0);
                    break;
                case 'animalLover':
                    ach.progress = gameData.animals.filter(a => a).length;
                    break;
                case 'millionaire':
                    ach.progress = gameData.player.coins;
                    break;
                case 'speedFarmer':
                    ach.progress = gameData.harvestStreak;
                    break;
            }

            if (!ach.completed && ach.progress >= (achievement.target || 1)) {
                ach.completed = true;
                showPopup('Achievement Unlocked!', `üèÜ ${achievement.name}\n${achievement.desc}\n\nReward: ${achievement.reward} ${achievement.type === 'diamonds' ? 'üíé' : 'üí∞'}`);
            }
        }

        function claimQuestReward() {
            if (gameData.dailyQuest.progress >= gameData.dailyQuest.target && !gameData.dailyQuest.claimed) {
                gameData.dailyQuest.claimed = true;
                gameData.player.diamonds += 3;
                
                updateUI();
                saveGame();
                
                showPopup('Quest Complete!', 'üéØ Daily quest completed!\n\n+3 üíé Diamonds');
            }
        }

        function collectAllReady() {
            let collected = 0;
            
            gameData.crops.forEach((crop, index) => {
                if (crop) {
                    const now = Date.now();
                    if (now >= crop.plantTime + crop.growTime) {
                        harvestCrop(index);
                        collected++;
                    }
                }
            });

            if (collected === 0) {
                showPopup('No Ready Crops', 'No crops are ready for harvest yet!');
            } else {
                showPopup('Harvest Complete!', `üåæ Collected ${collected} crops!`);
            }
        }

        function showFloatingNumber(text, element) {
            const floatingNumber = document.createElement('div');
            floatingNumber.className = 'floating-number';
            floatingNumber.textContent = text;
            floatingNumber.style.color = text.includes('üí∞') ? '#FFD700' : text.includes('üíé') ? '#E91E63' : '#4CAF50';
            
            const rect = element.getBoundingClientRect();
            floatingNumber.style.left = rect.left + rect.width / 2 + 'px';
            floatingNumber.style.top = rect.top + 'px';
            
            document.body.appendChild(floatingNumber);
            
            setTimeout(() => floatingNumber.remove(), 2000);
        }

        // UI Functions
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            if (tabName === 'store') {
                switchStoreTab('seeds');
            }
        }

        function switchStoreTab(category) {
            generateStoreContent(category);
        }

        function generateStoreContent(category) {
            const container = document.getElementById('store-content');
            container.innerHTML = '';

            switch (category) {
                case 'seeds':
                    Object.keys(cropTypes).forEach(seedType => {
                        const crop = cropTypes[seedType];
                        const item = document.createElement('div');
                        item.className = 'store-item';
                        item.onclick = () => buySeed(seedType);
                        item.innerHTML = `
                            <div class="item-icon">${crop.icon}</div>
                            <div class="item-name">${crop.name} Seeds</div>
                            <div class="item-price">üí∞ ${crop.seedCost}</div>
                            <div style="font-size: 12px;">Grow time: ${formatTime(crop.growTime)}</div>
                        `;
                        container.appendChild(item);
                    });
                    break;
                    
                case 'upgrades':
                    const upgrades = [
                        { name: 'Fast Growth', desc: 'Reduce crop grow time by 20%', cost: 100, type: 'coins', id: 'growthSpeed' },
                        { name: 'Better Yield', desc: 'Increase crop value by 50%', cost: 200, type: 'coins', id: 'yieldMultiplier' },
                        { name: 'Extra Land', desc: 'Add 2 more land plots', cost: 50, type: 'diamonds', id: 'landPlots' },
                        { name: 'Animal Pen', desc: 'Add 2 more animal pens', cost: 30, type: 'diamonds', id: 'animalPens' }
                    ];
                    
                    upgrades.forEach(upgrade => {
                        const item = document.createElement('div');
                        item.className = 'store-item';
                        item.onclick = () => buyUpgrade(upgrade);
                        item.innerHTML = `
                            <div class="item-icon">‚ö°</div>
                            <div class="item-name">${upgrade.name}</div>
                            <div class="item-price">${upgrade.type === 'coins' ? 'üí∞' : 'üíé'} ${upgrade.cost}</div>
                            <div style="font-size: 12px;">${upgrade.desc}</div>
                        `;
                        container.appendChild(item);
                    });
                    break;
                    
                case 'supplies':
                    const supplies = [
                        { name: 'Animal Feed', icon: 'üåæ', cost: 5, type: 'coins', id: 'feed' },
                        { name: 'Medicine', icon: 'üíä', cost: 15, type: 'coins', id: 'medicine' },
                        { name: 'Double Coins Boost', icon: 'üí∞', cost: 10, type: 'diamonds', id: 'doubleCoins', duration: 300000 },
                        { name: 'Fast Growth Boost', icon: '‚ö°', cost: 8, type: 'diamonds', id: 'fastGrowth', duration: 180000 },
                        { name: 'Lucky Chance Boost', icon: 'üçÄ', cost: 12, type: 'diamonds', id: 'luckyChance', duration: 240000 }
                    ];
                    
                    supplies.forEach(supply => {
                        const item = document.createElement('div');
                        item.className = 'store-item';
                        item.onclick = () => buySupply(supply);
                        item.innerHTML = `
                            <div class="item-icon">${supply.icon}</div>
                            <div class="item-name">${supply.name}</div>
                            <div class="item-price">${supply.type === 'coins' ? 'üí∞' : 'üíé'} ${supply.cost}</div>
                            <div style="font-size: 12px;">${supply.duration ? `Duration: ${formatTime(supply.duration)}` : 'Consumable item'}</div>
                        `;
                        container.appendChild(item);
                    });
                    break;
            }
        }

        function buySeed(seedType) {
            const crop = cropTypes[seedType];
            if (gameData.player.coins < crop.seedCost) {
                showPopup('Not Enough Coins', `You need ${crop.seedCost} coins to buy ${crop.name} seeds!`);
                return;
            }

            gameData.player.coins -= crop.seedCost;
            if (!gameData.inventory.seeds[seedType]) {
                gameData.inventory.seeds[seedType] = 0;
            }
            gameData.inventory.seeds[seedType] += 5;

            updateUI();
            saveGame();
            
            showPopup('Seeds Purchased!', `You bought 5 ${crop.name} seeds! üå±`);
        }

        function buyUpgrade(upgrade) {
            const cost = upgrade.cost;
            const currency = upgrade.type;
            
            if ((currency === 'coins' && gameData.player.coins < cost) || 
                (currency === 'diamonds' && gameData.player.diamonds < cost)) {
                showPopup('Not Enough Currency', `You need ${cost} ${currency} for this upgrade!`);
                return;
            }

            if (currency === 'coins') {
                gameData.player.coins -= cost;
            } else {
                gameData.player.diamonds -= cost;
            }

            switch (upgrade.id) {
                case 'growthSpeed':
                    gameData.upgrades.growthSpeed *= 0.8;
                    break;
                case 'yieldMultiplier':
                    gameData.upgrades.yieldMultiplier += 0.5;
                    break;
                case 'landPlots':
                    gameData.landPlots += 2;
                    break;
                case 'animalPens':
                    gameData.animalPens += 2;
                    break;
            }

            updateUI();
            saveGame();
            
            showPopup('Upgrade Purchased!', `${upgrade.name} upgrade acquired! ‚ö°`);
        }

        function buySupply(supply) {
            const cost = supply.cost;
            const currency = supply.type;
            
            if ((currency === 'coins' && gameData.player.coins < cost) || 
                (currency === 'diamonds' && gameData.player.diamonds < cost)) {
                showPopup('Not Enough Currency', `You need ${cost} ${currency} for this item!`);
                return;
            }

            if (currency === 'coins') {
                gameData.player.coins -= cost;
            } else {
                gameData.player.diamonds -= cost;
            }

            if (supply.duration) {
                // It's a boost
                gameData.boosts[supply.id] = supply.duration;
                
                // Set timer to remove boost
                setTimeout(() => {
                    gameData.boosts[supply.id] = 0;
                    updateUI();
                    showPopup('Boost Expired', `${supply.name} has expired!`);
                }, supply.duration);
            } else {
                // It's a supply item
                if (!gameData.inventory.supplies[supply.id]) {
                    gameData.inventory.supplies[supply.id] = 0;
                }
                gameData.inventory.supplies[supply.id] += supply.id === 'feed' ? 10 : 1;
            }

            updateUI();
            saveGame();
            
            showPopup('Item Purchased!', `${supply.name} acquired! ${supply.icon}`);
        }

        function showInventory() {
            switchInventoryTab('crops');
            document.getElementById('inventory-modal').style.display = 'block';
        }

        function switchInventoryTab(category) {
            const container = document.getElementById('inventory-content');
            container.innerHTML = '';

            // Update tab buttons
            document.querySelectorAll('#inventory-modal .tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            switch (category) {
                case 'crops':
                    Object.keys(gameData.inventory.crops).forEach(cropType => {
                        const count = gameData.inventory.crops[cropType];
                        if (count > 0) {
                            const crop = cropTypes[cropType];
                            const item = document.createElement('div');
                            item.className = 'inventory-item';
                            item.innerHTML = `
                                <div class="inventory-icon">${crop.icon}</div>
                                <div class="item-name">${crop.name}</div>
                                <div class="inventory-count">${count}</div>
                                <button class="btn btn-primary" onclick="sellCrop('${cropType}')">Sell All</button>
                            `;
                            container.appendChild(item);
                        }
                    });
                    break;
                    
                case 'animals':
                    Object.keys(gameData.inventory.animalProducts).forEach(productType => {
                        const count = gameData.inventory.animalProducts[productType];
                        if (count > 0) {
                            const icons = { egg: 'ü•ö', milk: 'ü•õ', wool: 'üß∂', meat: 'ü•©' };
                            const item = document.createElement('div');
                            item.className = 'inventory-item';
                            item.innerHTML = `
                                <div class="inventory-icon">${icons[productType] || 'üì¶'}</div>
                                <div class="item-name">${productType.charAt(0).toUpperCase() + productType.slice(1)}</div>
                                <div class="inventory-count">${count}</div>
                                <button class="btn btn-primary" onclick="sellAnimalProduct('${productType}')">Sell All</button>
                            `;
                            container.appendChild(item);
                        }
                    });
                    break;
                    
                case 'seeds':
                    Object.keys(gameData.inventory.seeds).forEach(seedType => {
                        const count = gameData.inventory.seeds[seedType];
                        if (count > 0) {
                            const crop = cropTypes[seedType];
                            const item = document.createElement('div');
                            item.className = 'inventory-item';
                            item.innerHTML = `
                                <div class="inventory-icon">${crop.icon}</div>
                                <div class="item-name">${crop.name} Seeds</div>
                                <div class="inventory-count">${count}</div>
                            `;
                            container.appendChild(item);
                        }
                    });
                    break;
            }

            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No items in this category</p>';
            }
        }

        function sellCrop(cropType) {
            const count = gameData.inventory.crops[cropType];
            const value = cropTypes[cropType].baseValue;
            const totalValue = count * value;
            
            gameData.player.coins += totalValue;
            gameData.inventory.crops[cropType] = 0;

            // Update quest progress
            if (gameData.dailyQuest.type === 'earn') {
                gameData.dailyQuest.progress += totalValue;
            }

            updateUI();
            saveGame();
            
            showPopup('Crops Sold!', `Sold ${count} ${cropTypes[cropType].name} for ${totalValue} coins! üí∞`);
            switchInventoryTab('crops');
        }

        function sellAnimalProduct(productType) {
            const count = gameData.inventory.animalProducts[productType];
            const values = { egg: 8, milk: 12, wool: 20, meat: 30 };
            const value = values[productType] || 10;
            const totalValue = count * value;
            
            gameData.player.coins += totalValue;
            gameData.inventory.animalProducts[productType] = 0;

            // Update quest progress
            if (gameData.dailyQuest.type === 'earn') {
                gameData.dailyQuest.progress += totalValue;
            }

            updateUI();
            saveGame();
            
            showPopup('Products Sold!', `Sold ${count} ${productType} for ${totalValue} coins! üí∞`);
            switchInventoryTab('animals');
        }

        function showAchievements() {
            const container = document.getElementById('achievements-content');
            container.innerHTML = '';

            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                const progress = gameData.achievements[achievementId] || { progress: 0, completed: false, claimed: false };
                
                const item = document.createElement('div');
                item.className = `achievement-item ${progress.completed ? 'completed' : ''}`;
                
                const progressText = achievement.target ? 
                    `${Math.min(progress.progress, achievement.target)}/${achievement.target}` : 
                    (progress.completed ? 'Completed' : 'Not completed');
                
                item.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <h4>${achievement.name}</h4>
                        <p>${achievement.desc}</p>
                        <p style="color: #666;">Progress: ${progressText}</p>
                    </div>
                    <div class="achievement-reward ${progress.completed && !progress.claimed ? '' : 'claimed'}" 
                         onclick="${progress.completed && !progress.claimed ? `claimAchievement('${achievementId}')` : ''}">
                        ${progress.claimed ? 'Claimed' : `${achievement.reward} ${achievement.type === 'diamonds' ? 'üíé' : 'üí∞'}`}
                    </div>
                `;
                
                container.appendChild(item);
            });

            document.getElementById('achievements-modal').style.display = 'block';
        }

        function claimAchievement(achievementId) {
            const achievement = achievements[achievementId];
            const progress = gameData.achievements[achievementId];
            
            if (progress && progress.completed && !progress.claimed) {
                progress.claimed = true;
                
                if (achievement.type === 'diamonds') {
                    gameData.player.diamonds += achievement.reward;
                } else {
                    gameData.player.coins += achievement.reward;
                }
                
                updateUI();
                saveGame();
                
                showPopup('Reward Claimed!', `You received ${achievement.reward} ${achievement.type === 'diamonds' ? 'üíé' : 'üí∞'}!`);
                showAchievements(); // Refresh the achievements display
            }
        }

        function showProfile() {
            const container = document.getElementById('profile-content');
            const playtime = Math.floor((Date.now() - gameData.player.sessionStartTime + gameData.player.totalPlayTime) / 1000 / 60);
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <h3>üë§ ${gameData.player.name}</h3>
                    <p>Level ${gameData.player.level} ${getBadge(gameData.player.xp)} Farmer</p>
                    <div style="margin: 20px 0;">
                        <p><strong>Total XP:</strong> ${gameData.player.xp}</p>
                        <p><strong>Total Coins Earned:</strong> ${gameData.player.coins}</p>
                        <p><strong>Total Diamonds:</strong> ${gameData.player.diamonds}</p>
                        <p><strong>Land Plots:</strong> ${gameData.landPlots}</p>
                        <p><strong>Animal Pens:</strong> ${gameData.animalPens}</p>
                        <p><strong>Play Time:</strong> ${playtime} minutes</p>
                        <p><strong>Login Streak:</strong> ${gameData.player.loginStreak} days</p>
                    </div>
                    <button class="btn btn-secondary" onclick="changeName()">Change Name</button>
                </div>
            `;

            document.getElementById('profile-modal').style.display = 'block';
        }

        function changeName() {
            const newName = prompt('Enter your new farmer name:', gameData.player.name);
            if (newName && newName.trim()) {
                gameData.player.name = newName.trim();
                updateUI();
                saveGame();
                showProfile();
            }
        }

        function showQuickActions() {
            let content = '<h3>‚ö° Quick Actions</h3>';
            content += '<div style="display: flex; flex-direction: column; gap: 10px;">';
            content += '<button class="btn btn-primary" onclick="useInstantHarvest()">üíé Instant Harvest All (5 üíé)</button>';
            content += '<button class="btn btn-primary" onclick="useInstantGrowth()">üíé Instant Growth Boost (3 üíé)</button>';
            content += '<button class="btn btn-secondary" onclick="restoreEnergy()">üíé Restore Energy (2 üíé)</button>';
            content += '<button class="btn btn-secondary" onclick="dailyBonus()">üéÅ Daily Login Bonus</button>';
            content += '</div>';
            
            showCustomModal('quick-actions', content);
        }

        function useInstantHarvest() {
            if (gameData.player.diamonds < 5) {
                showPopup('Not Enough Diamonds', 'You need 5 diamonds for instant harvest!');
                return;
            }

            const cropsToHarvest = gameData.crops.filter(crop => crop).length;
            if (cropsToHarvest === 0) {
                showPopup('No Crops', 'You have no crops to harvest!');
                return;
            }

            gameData.player.diamonds -= 5;
            
            gameData.crops.forEach((crop, index) => {
                if (crop) {
                    harvestCrop(index);
                }
            });

            closeModal('custom-modal');
            updateUI();
            saveGame();
            
            showPopup('Instant Harvest!', `‚ö° Instantly harvested ${cropsToHarvest} crops!`);
        }

        function useInstantGrowth() {
            if (gameData.player.diamonds < 3) {
                showPopup('Not Enough Diamonds', 'You need 3 diamonds for instant growth!');
                return;
            }

            const growingCrops = gameData.crops.filter(crop => crop && Date.now() < crop.plantTime + crop.growTime).length;
            if (growingCrops === 0) {
                showPopup('No Growing Crops', 'You have no crops that are still growing!');
                return;
            }

            gameData.player.diamonds -= 3;
            
            gameData.crops.forEach(crop => {
                if (crop && Date.now() < crop.plantTime + crop.growTime) {
                    crop.plantTime = Date.now() - crop.growTime; // Make it ready
                }
            });

            closeModal('custom-modal');
            updateUI();
            saveGame();
            
            showPopup('Instant Growth!', `‚ö° All crops are now ready to harvest!`);
        }

        function restoreEnergy() {
            if (gameData.player.diamonds < 2) {
                showPopup('Not Enough Diamonds', 'You need 2 diamonds to restore energy!');
                return;
            }

            gameData.player.diamonds -= 2;
            gameData.player.energy = gameData.player.maxEnergy;

            closeModal('custom-modal');
            updateUI();
            saveGame();
            
            showPopup('Energy Restored!', '‚ö° Your energy has been fully restored!');
        }

        function dailyBonus() {
            const now = Date.now();
            const lastLogin = gameData.player.lastLogin;
            const oneDayMs = 24 * 60 * 60 * 1000;

            if (now - lastLogin < oneDayMs) {
                showPopup('Already Claimed', 'You have already claimed your daily bonus today!');
                return;
            }

            // Calculate streak
            if (now - lastLogin <= oneDayMs * 2) {
                gameData.player.loginStreak++;
            } else {
                gameData.player.loginStreak = 1;
            }

            gameData.player.lastLogin = now;
            
            // Give bonus based on streak
            const bonusDiamonds = Math.min(gameData.player.loginStreak, 7);
            gameData.player.diamonds += bonusDiamonds;

            closeModal('custom-modal');
            updateUI();
            saveGame();
            
            showPopup('Daily Bonus!', `üéÅ Day ${gameData.player.loginStreak} bonus!\n+${bonusDiamonds} üíé Diamonds`);
        }

        function showPopup(title, message, confirmCallback = null) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').textContent = message;
            
            const confirmBtn = document.getElementById('popup-confirm');
            const cancelBtn = document.getElementById('popup-cancel');
            
            if (confirmCallback) {
                confirmBtn.textContent = 'Yes';
                confirmBtn.onclick = () => {
                    confirmCallback();
                    hidePopup();
                };
                cancelBtn.style.display = 'block';
            } else {
                confirmBtn.textContent = 'OK';
                confirmBtn.onclick = hidePopup;
                cancelBtn.style.display = 'none';
            }
            
            document.getElementById('popup').classList.add('show');
        }

        function hidePopup() {
            document.getElementById('popup').classList.remove('show');
        }

        function showCustomModal(id, content) {
            // Remove existing custom modal
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create new modal
            const modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal('custom-modal')">&times;</span>
                    ${content}
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                if (modalId === 'custom-modal') {
                    modal.remove();
                }
            }
        }

        // Game Loop
        function gameLoop() {
            // Update energy
            if (gameData.player.energy < gameData.player.maxEnergy) {
                gameData.player.energy = Math.min(gameData.player.energy + 1, gameData.player.maxEnergy);
            }

            // Update boosts
            Object.keys(gameData.boosts).forEach(boostType => {
                if (gameData.boosts[boostType] > 0) {
                    gameData.boosts[boostType] -= 1000;
                    if (gameData.boosts[boostType] <= 0) {
                        gameData.boosts[boostType] = 0;
                    }
                }
            });

            // Update animals
            gameData.animals.forEach((animal, index) => {
                if (animal) {
                    const now = Date.now();
                    const animalType = animalTypes[animal.type];
                    
                    // Check if needs food
                    if (now - animal.lastFed > 300000) { // 5 minutes
                        animal.needsFood = true;
                        animal.happiness = Math.max(animal.happiness - 1, 0);
                    }
                    
                    // Check if gets sick
                    if (animal.happiness < 20 && Math.random() < 0.001) {
                        animal.sick = true;
                        animal.canProduce = false;
                    }
                    
                    // Check production
                    if (animalType.product && !animal.sick && !animal.needsFood) {
                        if (now - animal.lastProduct >= animalType.productTime) {
                            animal.canProduce = true;
                        }
                    }
                }
            });

            // Reset harvest streak if no action for 30 seconds
            if (Date.now() - gameData.lastAction > 30000) {
                gameData.harvestStreak = 0;
            }

            updateUI();
            saveGame();
        }

        // Initialize Game
        function initGame() {
            loadGame();
            updateUI();
            
            // Start game loop
            setInterval(gameLoop, 1000);
            
            // Auto-save every 10 seconds
            setInterval(saveGame, 10000);
        }

        // Start the game when page loads
        window.addEventListener('load', initGame);
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            gameData.player.totalPlayTime += Date.now() - gameData.player.sessionStartTime;
            saveGame();
        });
    </script>
</body>
</html>
