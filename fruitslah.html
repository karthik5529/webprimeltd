
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Slash - Ultimate Edition</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRnJ1aXQgU2xhc2giLCJzaG9ydF9uYW1lIjoiRnJ1aXRTbGFzaCIsImRlc2NyaXB0aW9uIjoiVWx0aW1hdGUgRnJ1aXQgU2xhc2ggR2FtZSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDAwMDAwIiwidGhlbWVfY29sb3IiOiIjRkY2QjM1IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5qUWlJR2hsYVdkb2REMGlOalFpSUhabGNuTnBiMjQ5SWpFdU1TSWdlRzFzYm5NOUltaDBkSEE2TDI5M2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBpQThjbVZqZENCM2FXUjBhRDBpTmpRaUlHaGxhV2RvZEQwaU5qUWlJR1pwYkd3OUlpTkdSamhDTXpVaUx6NGdQR1pwY25OMExXTm9hV3hrSUdacGJHdzlJaU5HUmpoQ016VWlJR2h2Y21sNmIyNTBZV3d0WVd4cFoyNXRaVzUwUFNKdGFXUmtiR1VpUGlBOGRHVjRkQ0I0UFNJek1pSWdlVDBpTVRraUlHWnBiR3c5SWlOemRHOXlZV2RsWkNJZ1ptOXVkQzF6YVhwbFBTSXpOaUJ3ZUNJKzQ0K0Y4SzJ2Y0dGMGRHVnlibDg4TDJacGNuTjBMV05vYVd4a1BpQThkR1Y0ZENCNFBTSXpNaUlnZVQwaU16a2lJR1pwYkd3OUlpTnpkRzl5WVdkbFpDSWdabTl1ZEMxemFYcGxQU0l6Tm1GMGVHVjBlQ0krS05WQmJDWjhiaTkwYVdGc0xtNW5jRG84TDJocGFXZG9kRDBpTmpSY1hTSTZKWGxjT3lxZ2hVVWl1LzcyNW94aWJaQk52V1c2K0JaIn1dLCJzdGFydF91cmwiOiIvZnJ1aXRzbGFzaC5odG1sIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMDAwMCIsInRoZW1lX2NvbG9yIjoiI0ZGNkIzNSJ9">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Game Canvas */
        #gameCanvas {
            display: block;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            cursor: crosshair;
            transition: all 0.3s ease;
        }

        /* UI Overlays */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ui-overlay > * {
            pointer-events: auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            flex-wrap: wrap;
        }

        .score-section {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .combo-display {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            animation: pulse 1s infinite;
        }

        /* Popup System */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            color: white;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .popup h2 {
            margin-bottom: 20px;
            color: #FFD700;
        }

        .popup button {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .popup button:hover {
            background: #E55A2B;
            transform: scale(1.05);
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #E55A2B;
            transform: scale(1.05);
        }

        /* Power-ups */
        .power-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .power-item {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .power-item:hover {
            background: rgba(255,107,53,0.8);
            transform: scale(1.1);
        }

        /* Mascot */
        .mascot {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .mascot:hover {
            transform: scale(1.1) rotate(10deg);
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes explosion {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .score-section {
                gap: 10px;
            }
            
            .power-display {
                bottom: 10px;
                left: 10px;
            }
            
            .mascot {
                width: 60px;
                height: 60px;
                font-size: 30px;
                bottom: 10px;
                right: 10px;
            }
            
            .popup {
                padding: 20px;
                margin: 10px;
            }
        }

        /* Menu System */
        .main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .menu-title {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .menu-btn {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 250px;
        }

        .menu-btn:hover {
            background: #E55A2B;
            transform: scale(1.05);
        }

        /* Skills Tree */
        .skills-tree {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .skill-node {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .skill-node.unlocked {
            border-color: #FFD700;
            background: rgba(255,215,0,0.2);
        }

        .skill-node:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.2);
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B35, #FFD700);
            transition: width 0.3s ease;
        }

        /* Leaderboard */
        .leaderboard {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        /* Split Screen for Multiplayer */
        .split-screen {
            display: flex;
            height: 100vh;
        }

        .player-area {
            flex: 1;
            position: relative;
            border-right: 2px solid #FFD700;
        }

        .player-area:last-child {
            border-right: none;
        }

        /* Floating Numbers */
        .floating-number {
            position: absolute;
            color: #FFD700;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FF6B35;
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="mainMenu" class="main-menu">
        <h1 class="menu-title">üçé FRUIT SLASH üçé</h1>
        <div class="menu-buttons">
            <button class="menu-btn" onclick="startGame('classic')">üéÆ Classic Mode</button>
            <button class="menu-btn" onclick="startGame('battle')">‚öîÔ∏è Battle Mode</button>
            <button class="menu-btn" onclick="startGame('ai')">ü§ñ AI Challenge</button>
            <button class="menu-btn" onclick="startGame('timed')">‚è±Ô∏è Time Challenge</button>
            <button class="menu-btn" onclick="showPopup('missions')">üéØ Missions</button>
            <button class="menu-btn" onclick="showPopup('skills')">üß¨ Skills Tree</button>
            <button class="menu-btn" onclick="showPopup('shop')">üõí Shop</button>
            <button class="menu-btn" onclick="showPopup('profile')">üë§ Profile</button>
            <button class="menu-btn" onclick="showPopup('settings')">‚öôÔ∏è Settings</button>
        </div>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas" style="display: none;"></canvas>

    <!-- UI Overlay -->
    <div class="ui-overlay" style="display: none;" id="gameUI">
        <!-- Header -->
        <div class="header">
            <div class="score-section">
                <div class="score-item">
                    <span>üéØ</span>
                    <span id="score">0</span>
                </div>
                <div class="score-item">
                    <span>ü™ô</span>
                    <span id="coins">0</span>
                </div>
                <div class="score-item">
                    <span>üíé</span>
                    <span id="diamonds">0</span>
                </div>
                <div class="combo-display" id="combo">
                    COMBO: <span id="comboCount">0</span>x
                </div>
                <div class="score-item">
                    <span>‚ù§Ô∏è</span>
                    <span id="lives">3</span>
                </div>
            </div>
            <div class="controls">
                <button class="control-btn" onclick="pauseGame()">‚è∏Ô∏è Pause</button>
                <button class="control-btn" onclick="showPopup('missions')">üéØ</button>
                <button class="control-btn" onclick="showPopup('shop')">üõí</button>
                <button class="control-btn" onclick="backToMenu()">üè†</button>
            </div>
        </div>

        <!-- Power-ups Display -->
        <div class="power-display" id="powerDisplay">
            <!-- Power-ups will be added dynamically -->
        </div>

        <!-- Mascot -->
        <div class="mascot" id="mascot" onclick="petMascot()">
            <span id="mascotFace">üòä</span>
        </div>
    </div>

    <!-- Popup Overlay -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup" id="popupContent">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt" onclick="installApp()">
        üì± Install Fruit Slash
    </div>

    <script>
        // Game State
        let gameState = {
            mode: 'menu',
            isPlaying: false,
            isPaused: false,
            score: 0,
            coins: 0,
            diamonds: 0,
            lives: 3,
            combo: 0,
            maxCombo: 0,
            level: 1,
            xp: 0,
            slashTrail: 'default',
            fruitTheme: 'classic',
            musicPack: 'calm',
            timeLeft: 0,
            gameMode: 'classic'
        };

        // Game Data Storage
        let gameData = {
            username: '',
            totalScore: 0,
            totalCoins: 0,
            totalDiamonds: 0,
            totalXP: 0,
            level: 1,
            skills: {},
            achievements: {},
            settings: {
                sound: true,
                music: true,
                vibration: true,
                theme: 'default'
            },
            dailyMissions: [],
            weeklyMissions: [],
            vault: {
                coins: 0,
                lastInterest: Date.now()
            },
            inventory: {
                slowMotion: 0,
                doublePoints: 0,
                shieldPower: 0,
                fruitMagnet: 0
            },
            friends: [],
            stats: {
                gamesPlayed: 0,
                fruitsSliced: 0,
                bombsHit: 0,
                perfectCombos: 0,
                totalPlayTime: 0
            }
        };

        // Canvas and Context
        let canvas, ctx;
        let fruits = [];
        let particles = [];
        let slashTrails = [];
        let powerUps = [];

        // Game Objects
        class Fruit {
            constructor(x, y, type, velocity) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.velocity = velocity || { x: Math.random() * 4 - 2, y: -Math.random() * 8 - 5 };
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.2;
                this.size = 40 + Math.random() * 20;
                this.sliced = false;
                this.gravity = 0.3;
                this.emoji = this.getFruitEmoji();
                this.points = this.getFruitPoints();
                this.special = Math.random() < 0.1; // 10% chance for special fruit
            }

            getFruitEmoji() {
                const fruits = ['üçé', 'üçä', 'üçå', 'üçá', 'üçì', 'ü•ù', 'üçë', 'üçí', 'ü•≠', 'üçç'];
                const tropical = ['ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçå'];
                const galaxy = ['‚≠ê', 'üåü', '‚ú®', 'üí´', 'üå†'];
                
                let fruitSet = fruits;
                if (gameData.settings.theme === 'tropical') fruitSet = tropical;
                if (gameData.settings.theme === 'galaxy') fruitSet = galaxy;
                
                if (this.special) return 'üåü'; // Special fruit
                return fruitSet[Math.floor(Math.random() * fruitSet.length)];
            }

            getFruitPoints() {
                if (this.special) return 50;
                return 10 + Math.floor(Math.random() * 10);
            }

            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.velocity.y += this.gravity;
                this.rotation += this.rotationSpeed;
            }

            draw(context) {
                context.save();
                context.translate(this.x, this.y);
                context.rotate(this.rotation);
                context.font = `${this.size}px Arial`;
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                
                if (this.special) {
                    context.shadowColor = '#FFD700';
                    context.shadowBlur = 10;
                }
                
                context.fillText(this.emoji, 0, 0);
                context.restore();
            }

            isClicked(x, y) {
                const distance = Math.sqrt((x - this.x) ** 2 + (y - this.y) ** 2);
                return distance < this.size / 2;
            }

            slice() {
                if (this.sliced) return;
                this.sliced = true;
                
                // Add score and effects
                addScore(this.points);
                createParticles(this.x, this.y, this.emoji);
                playSound('slice');
                
                // Add floating number
                createFloatingNumber(this.x, this.y, `+${this.points}`);
                
                if (this.special) {
                    gameState.diamonds += 1;
                    updateDisplay();
                    createFloatingNumber(this.x, this.y + 30, '+1üíé');
                }
                
                // Update stats
                gameData.stats.fruitsSliced++;
                updateMascotEmotion('happy');
            }
        }

        class Bomb {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.velocity = { x: Math.random() * 4 - 2, y: -Math.random() * 8 - 5 };
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.2;
                this.size = 45;
                this.gravity = 0.3;
                this.emoji = 'üí£';
                this.sliced = false;
            }

            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.velocity.y += this.gravity;
                this.rotation += this.rotationSpeed;
            }

            draw(context) {
                context.save();
                context.translate(this.x, this.y);
                context.rotate(this.rotation);
                context.font = `${this.size}px Arial`;
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(this.emoji, 0, 0);
                context.restore();
            }

            isClicked(x, y) {
                const distance = Math.sqrt((x - this.x) ** 2 + (y - this.y) ** 2);
                return distance < this.size / 2;
            }

            explode() {
                if (this.sliced) return;
                this.sliced = true;
                
                gameState.lives--;
                gameState.combo = 0;
                createExplosion(this.x, this.y);
                playSound('bomb');
                updateMascotEmotion('angry');
                gameData.stats.bombsHit++;
                
                if (gameState.lives <= 0) {
                    endGame();
                }
                
                updateDisplay();
            }
        }

        // Initialize Game
        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Load game data
            loadGameData();
            
            // Setup controls
            setupControls();
            
            // Setup PWA
            setupPWA();
            
            // Initialize missions
            initializeMissions();
            
            // Start auto-save
            setInterval(saveGameData, 10000); // Auto-save every 10 seconds
            
            // Check for install prompt
            setTimeout(checkInstallPrompt, 60000); // Show after 1 minute
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function setupControls() {
            let isSlashing = false;
            let lastTouch = { x: 0, y: 0 };

            // Mouse controls
            canvas.addEventListener('mousedown', (e) => {
                isSlashing = true;
                handleSlash(e.clientX, e.clientY);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isSlashing) {
                    handleSlash(e.clientX, e.clientY);
                    createSlashTrail(e.clientX, e.clientY);
                }
            });

            canvas.addEventListener('mouseup', () => {
                isSlashing = false;
            });

            // Touch controls
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isSlashing = true;
                const touch = e.touches[0];
                lastTouch = { x: touch.clientX, y: touch.clientY };
                handleSlash(touch.clientX, touch.clientY);
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isSlashing) {
                    const touch = e.touches[0];
                    handleSlash(touch.clientX, touch.clientY);
                    createSlashTrail(touch.clientX, touch.clientY);
                    lastTouch = { x: touch.clientX, y: touch.clientY };
                }
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isSlashing = false;
            });

            // Gamepad support
            window.addEventListener('gamepadconnected', (e) => {
                console.log('Gamepad connected:', e.gamepad);
            });
        }

        function handleSlash(x, y) {
            if (!gameState.isPlaying || gameState.isPaused) return;

            // Check fruits
            for (let fruit of fruits) {
                if (fruit.isClicked(x, y) && !fruit.sliced) {
                    fruit.slice();
                    gameState.combo++;
                    checkComboAchievements();
                    break;
                }
            }

            // Check bombs
            for (let bomb of fruits.filter(f => f instanceof Bomb)) {
                if (bomb.isClicked(x, y) && !bomb.sliced) {
                    bomb.explode();
                    break;
                }
            }
        }

        function createSlashTrail(x, y) {
            slashTrails.push({
                x: x,
                y: y,
                life: 20,
                maxLife: 20,
                color: getSlashTrailColor()
            });
        }

        function getSlashTrailColor() {
            switch (gameData.settings.slashTrail) {
                case 'fire': return '#FF4500';
                case 'ice': return '#00BFFF';
                case 'rainbow': return `hsl(${Date.now() % 360}, 100%, 50%)`;
                case 'thunder': return '#FFD700';
                default: return '#FFFFFF';
            }
        }

        // Game Logic
        function startGame(mode) {
            gameState.mode = mode;
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.score = 0;
            gameState.lives = 3;
            gameState.combo = 0;
            gameState.gameMode = mode;
            
            // Reset arrays
            fruits = [];
            particles = [];
            slashTrails = [];
            
            // Hide menu, show game
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            
            // Set up mode-specific settings
            switch (mode) {
                case 'timed':
                    gameState.timeLeft = 60; // 60 seconds
                    startTimer();
                    break;
                case 'battle':
                    setupBattleMode();
                    break;
                case 'ai':
                    setupAIMode();
                    break;
            }
            
            updateDisplay();
            startGameLoop();
            playBackgroundMusic();
        }

        function startGameLoop() {
            function gameLoop() {
                if (!gameState.isPlaying) return;
                
                update();
                render();
                
                if (!gameState.isPaused) {
                    requestAnimationFrame(gameLoop);
                }
            }
            gameLoop();
        }

        function update() {
            // Spawn fruits
            if (Math.random() < getSpawnRate()) {
                spawnFruit();
            }
            
            // Spawn bombs occasionally
            if (Math.random() < 0.02) {
                spawnBomb();
            }
            
            // Update game objects
            updateFruits();
            updateParticles();
            updateSlashTrails();
            updatePowerUps();
            
            // Update AI if in AI mode
            if (gameState.mode === 'ai') {
                updateAI();
            }
            
            // Check win/lose conditions
            checkGameEnd();
        }

        function getSpawnRate() {
            let baseRate = 0.03;
            
            // Increase spawn rate based on level
            baseRate += gameState.level * 0.005;
            
            // Friday Frenzy event
            if (isFridayFrenzy()) {
                baseRate *= 2;
            }
            
            return Math.min(baseRate, 0.1); // Cap at 10%
        }

        function spawnFruit() {
            const x = Math.random() * canvas.width;
            const y = canvas.height + 50;
            fruits.push(new Fruit(x, y));
        }

        function spawnBomb() {
            const x = Math.random() * canvas.width;
            const y = canvas.height + 50;
            fruits.push(new Bomb(x, y));
        }

        function updateFruits() {
            for (let i = fruits.length - 1; i >= 0; i--) {
                fruits[i].update();
                
                // Remove fruits that are off screen
                if (fruits[i].y > canvas.height + 100 || fruits[i].x < -100 || fruits[i].x > canvas.width + 100) {
                    if (!fruits[i].sliced && !(fruits[i] instanceof Bomb)) {
                        // Lost a fruit - lose combo and life
                        gameState.combo = 0;
                        gameState.lives = Math.max(0, gameState.lives - 1);
                        updateMascotEmotion('sad');
                    }
                    fruits.splice(i, 1);
                }
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].life--;
                particles[i].x += particles[i].vx;
                particles[i].y += particles[i].vy;
                particles[i].vy += 0.5; // gravity
                
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function updateSlashTrails() {
            for (let i = slashTrails.length - 1; i >= 0; i--) {
                slashTrails[i].life--;
                if (slashTrails[i].life <= 0) {
                    slashTrails.splice(i, 1);
                }
            }
        }

        function updatePowerUps() {
            // Update power-up durations
            Object.keys(gameState.activePowerUps || {}).forEach(power => {
                if (gameState.activePowerUps[power] > 0) {
                    gameState.activePowerUps[power]--;
                    if (gameState.activePowerUps[power] <= 0) {
                        delete gameState.activePowerUps[power];
                        updatePowerUpDisplay();
                    }
                }
            });
        }

        function render() {
            // Clear canvas
            ctx.fillStyle = getBackgroundGradient();
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw slash trails
            drawSlashTrails();
            
            // Draw fruits
            fruits.forEach(fruit => fruit.draw(ctx));
            
            // Draw particles
            drawParticles();
            
            // Draw special effects
            drawSpecialEffects();
        }

        function getBackgroundGradient() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            
            if (gameState.mode === 'battle') {
                gradient.addColorStop(0, '#FF6B35');
                gradient.addColorStop(1, '#764ba2');
            } else {
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#98FB98');
            }
            
            return gradient;
        }

        function drawSlashTrails() {
            if (slashTrails.length < 2) return;
            
            ctx.strokeStyle = getSlashTrailColor();
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(slashTrails[0].x, slashTrails[0].y);
            
            for (let i = 1; i < slashTrails.length; i++) {
                const alpha = slashTrails[i].life / slashTrails[i].maxLife;
                ctx.globalAlpha = alpha;
                ctx.lineTo(slashTrails[i].x, slashTrails[i].y);
            }
            
            ctx.stroke();
            ctx.globalAlpha = 1;
        }

        function drawParticles() {
            particles.forEach(particle => {
                ctx.save();
                ctx.globalAlpha = particle.life / particle.maxLife;
                ctx.font = `${particle.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(particle.emoji, particle.x, particle.y);
                ctx.restore();
            });
        }

        function drawSpecialEffects() {
            // Draw combo multiplier effect
            if (gameState.combo > 3) {
                ctx.save();
                ctx.font = '48px Arial';
                ctx.fillStyle = '#FFD700';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${gameState.combo}x COMBO!`, canvas.width / 2, 100);
                ctx.restore();
            }
        }

        // Utility Functions
        function addScore(points) {
            let multipliedPoints = points;
            
            // Apply combo multiplier
            if (gameState.combo > 1) {
                multipliedPoints = Math.floor(points * (1 + gameState.combo * 0.2));
            }
            
            // Friday Frenzy doubles points
            if (isFridayFrenzy()) {
                multipliedPoints *= 2;
            }
            
            gameState.score += multipliedPoints;
            gameState.coins += Math.floor(multipliedPoints / 10);
            
            // Chance for diamonds
            if (Math.random() < 0.05) {
                gameState.diamonds++;
            }
            
            updateDisplay();
            checkLevelUp();
        }

        function createParticles(x, y, emoji) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10 - 5,
                    life: 30,
                    maxLife: 30,
                    emoji: emoji,
                    size: 20 + Math.random() * 10
                });
            }
        }

        function createExplosion(x, y) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15 - 8,
                    life: 40,
                    maxLife: 40,
                    emoji: 'üí•',
                    size: 30 + Math.random() * 20
                });
            }
        }

        function createFloatingNumber(x, y, text) {
            const floatingNumber = document.createElement('div');
            floatingNumber.className = 'floating-number';
            floatingNumber.textContent = text;
            floatingNumber.style.left = x + 'px';
            floatingNumber.style.top = y + 'px';
            
            document.body.appendChild(floatingNumber);
            
            setTimeout(() => {
                document.body.removeChild(floatingNumber);
            }, 1000);
        }

        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('diamonds').textContent = gameState.diamonds;
            document.getElementById('comboCount').textContent = gameState.combo;
            document.getElementById('lives').textContent = gameState.lives;
            
            // Update max combo
            if (gameState.combo > gameState.maxCombo) {
                gameState.maxCombo = gameState.combo;
            }
        }

        function checkLevelUp() {
            const xpNeeded = gameState.level * 100;
            if (gameState.score >= xpNeeded) {
                gameState.level++;
                gameState.diamonds += 5;
                showPopupMessage('Level Up!', `Welcome to Level ${gameState.level}! +5 üíé`, 'success');
                playSound('levelup');
                createConfetti();
            }
        }

        function checkComboAchievements() {
            if (gameState.combo === 5 && Math.random() < 0.3) {
                gameData.inventory.slowMotion++;
                showPopupMessage('Combo Reward!', 'Earned Slow Motion Power! üêå', 'success');
            }
            
            if (gameState.combo === 10) {
                gameData.stats.perfectCombos++;
                unlockAchievement('combo_master');
            }
        }

        // Mascot System
        function updateMascotEmotion(emotion) {
            const mascotFace = document.getElementById('mascotFace');
            switch (emotion) {
                case 'happy':
                    mascotFace.textContent = 'üòÑ';
                    break;
                case 'sad':
                    mascotFace.textContent = 'üò¢';
                    break;
                case 'angry':
                    mascotFace.textContent = 'üò†';
                    break;
                case 'excited':
                    mascotFace.textContent = 'ü§©';
                    break;
                default:
                    mascotFace.textContent = 'üòä';
            }
            
            setTimeout(() => {
                mascotFace.textContent = 'üòä';
            }, 2000);
        }

        function petMascot() {
            const bonus = Math.floor(Math.random() * 50) + 10;
            gameState.coins += bonus;
            updateDisplay();
            updateMascotEmotion('excited');
            createFloatingNumber(canvas.width - 60, canvas.height - 60, `+${bonus}ü™ô`);
            playSound('pet');
        }

        // Mission System
        function initializeMissions() {
            // Daily missions
            gameData.dailyMissions = [
                {
                    id: 'slice_50_fruits',
                    title: 'Slice 50 fruits',
                    description: 'Slice 50 fruits today',
                    target: 50,
                    progress: 0,
                    reward: { diamonds: 2 },
                    completed: false,
                    claimed: false
                },
                {
                    id: 'combo_5_times',
                    title: 'Get 3x combo 5 times',
                    description: 'Achieve 3x combo streak 5 times',
                    target: 5,
                    progress: 0,
                    reward: { slowMotion: 1 },
                    completed: false,
                    claimed: false
                }
            ];
            
            // Weekly missions
            gameData.weeklyMissions = [
                {
                    id: 'earn_1000_coins',
                    title: 'Earn 1000 coins',
                    description: 'Earn 1000 coins this week',
                    target: 1000,
                    progress: 0,
                    reward: { diamonds: 10 },
                    completed: false,
                    claimed: false
                }
            ];
        }

        function updateMissionProgress(missionType, progress) {
            const missions = missionType === 'daily' ? gameData.dailyMissions : gameData.weeklyMissions;
            
            missions.forEach(mission => {
                if (!mission.completed) {
                    switch (mission.id) {
                        case 'slice_50_fruits':
                            mission.progress = gameData.stats.fruitsSliced % 50;
                            break;
                        case 'combo_5_times':
                            if (gameState.combo >= 3) mission.progress++;
                            break;
                        case 'earn_1000_coins':
                            mission.progress = gameState.coins;
                            break;
                    }
                    
                    if (mission.progress >= mission.target) {
                        mission.completed = true;
                        showPopupMessage('Mission Complete!', mission.title, 'success');
                    }
                }
            });
        }

        // Events System
        function isFridayFrenzy() {
            const now = new Date();
            return now.getDay() === 5; // Friday
        }

        function checkDailyBonus() {
            const lastBonus = localStorage.getItem('lastDailyBonus');
            const today = new Date().toDateString();
            
            if (lastBonus !== today) {
                gameState.diamonds += 3;
                localStorage.setItem('lastDailyBonus', today);
                showPopupMessage('Daily Bonus!', 'Welcome back! +3 üíé', 'success');
            }
        }

        // Skills System
        function initializeSkills() {
            if (!gameData.skills) {
                gameData.skills = {
                    combo_boost: { level: 0, maxLevel: 5, cost: 100 },
                    fruit_magnet: { level: 0, maxLevel: 3, cost: 200 },
                    diamond_luck: { level: 0, maxLevel: 5, cost: 150 },
                    time_master: { level: 0, maxLevel: 3, cost: 300 }
                };
            }
        }

        function upgradeSkill(skillId) {
            const skill = gameData.skills[skillId];
            if (!skill || skill.level >= skill.maxLevel) return;
            
            const cost = skill.cost * (skill.level + 1);
            if (gameState.coins >= cost) {
                gameState.coins -= cost;
                skill.level++;
                updateDisplay();
                showPopupMessage('Skill Upgraded!', `${skillId.replace('_', ' ')} Level ${skill.level}`, 'success');
                saveGameData();
            }
        }

        // Achievement System
        function unlockAchievement(achievementId) {
            if (gameData.achievements[achievementId]) return;
            
            gameData.achievements[achievementId] = {
                unlocked: true,
                unlockedAt: Date.now(),
                claimed: false
            };
            
            const achievements = {
                first_slice: { title: 'First Slice', reward: { diamonds: 1 } },
                combo_master: { title: 'Combo Master', reward: { diamonds: 5 } },
                hundred_fruits: { title: '100 Fruits Sliced', reward: { diamonds: 10 } }
            };
            
            const achievement = achievements[achievementId];
            if (achievement) {
                showPopupMessage('Achievement Unlocked!', achievement.title, 'achievement');
            }
        }

        function claimAchievement(achievementId) {
            const achievement = gameData.achievements[achievementId];
            if (!achievement || achievement.claimed) return;
            
            achievement.claimed = true;
            
            const rewards = {
                first_slice: { diamonds: 1 },
                combo_master: { diamonds: 5 },
                hundred_fruits: { diamonds: 10 }
            };
            
            const reward = rewards[achievementId];
            if (reward.diamonds) {
                gameState.diamonds += reward.diamonds;
                updateDisplay();
            }
            
            saveGameData();
        }

        // AI System
        function setupAIMode() {
            gameState.aiScore = 0;
            gameState.aiDifficulty = 'medium';
        }

        function updateAI() {
            // Simple AI that "slices" fruits
            if (Math.random() < getAIDifficulty()) {
                const availableFruits = fruits.filter(f => !f.sliced && !(f instanceof Bomb));
                if (availableFruits.length > 0) {
                    const fruit = availableFruits[0];
                    gameState.aiScore += fruit.points;
                }
            }
        }

        function getAIDifficulty() {
            switch (gameState.aiDifficulty) {
                case 'easy': return 0.02;
                case 'medium': return 0.04;
                case 'hard': return 0.06;
                default: return 0.04;
            }
        }

        // Battle Mode
        function setupBattleMode() {
            document.body.innerHTML += `
                <div class="split-screen" id="splitScreen">
                    <div class="player-area">
                        <canvas id="player1Canvas"></canvas>
                        <div style="position: absolute; top: 10px; left: 10px; color: white;">
                            Player 1: <span id="player1Score">0</span>
                        </div>
                    </div>
                    <div class="player-area">
                        <canvas id="player2Canvas"></canvas>
                        <div style="position: absolute; top: 10px; right: 10px; color: white;">
                            Player 2: <span id="player2Score">0</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Power-up System
        function usePowerUp(powerType) {
            if (gameData.inventory[powerType] <= 0) return;
            
            gameData.inventory[powerType]--;
            
            if (!gameState.activePowerUps) gameState.activePowerUps = {};
            
            switch (powerType) {
                case 'slowMotion':
                    gameState.activePowerUps.slowMotion = 300; // 5 seconds at 60fps
                    break;
                case 'doublePoints':
                    gameState.activePowerUps.doublePoints = 600; // 10 seconds
                    break;
                case 'shieldPower':
                    gameState.activePowerUps.shieldPower = 1; // One hit protection
                    break;
                case 'fruitMagnet':
                    gameState.activePowerUps.fruitMagnet = 450; // 7.5 seconds
                    break;
            }
            
            updatePowerUpDisplay();
            saveGameData();
        }

        function updatePowerUpDisplay() {
            const powerDisplay = document.getElementById('powerDisplay');
            powerDisplay.innerHTML = '';
            
            // Show available power-ups
            Object.keys(gameData.inventory).forEach(power => {
                if (gameData.inventory[power] > 0) {
                    const powerItem = document.createElement('div');
                    powerItem.className = 'power-item';
                    powerItem.innerHTML = `${getPowerEmoji(power)} ${gameData.inventory[power]}`;
                    powerItem.onclick = () => usePowerUp(power);
                    powerDisplay.appendChild(powerItem);
                }
            });
            
            // Show active power-ups
            if (gameState.activePowerUps) {
                Object.keys(gameState.activePowerUps).forEach(power => {
                    const timeLeft = Math.ceil(gameState.activePowerUps[power] / 60);
                    const activeItem = document.createElement('div');
                    activeItem.className = 'power-item';
                    activeItem.style.background = 'rgba(255,215,0,0.8)';
                    activeItem.innerHTML = `${getPowerEmoji(power)} ${timeLeft}s`;
                    powerDisplay.appendChild(activeItem);
                });
            }
        }

        function getPowerEmoji(power) {
            switch (power) {
                case 'slowMotion': return 'üêå';
                case 'doublePoints': return '‚≠ê';
                case 'shieldPower': return 'üõ°Ô∏è';
                case 'fruitMagnet': return 'üß≤';
                default: return '‚ö°';
            }
        }

        // Game End Functions
        function endGame() {
            gameState.isPlaying = false;
            
            // Update stats
            gameData.stats.gamesPlayed++;
            gameData.totalScore += gameState.score;
            gameData.totalCoins += gameState.coins;
            gameData.totalDiamonds += gameState.diamonds;
            
            // Check for achievements
            if (gameData.stats.fruitsSliced >= 100) {
                unlockAchievement('hundred_fruits');
            }
            
            saveGameData();
            
            // Show game over popup
            showGameOverPopup();
        }

        function showGameOverPopup() {
            const content = `
                <h2>üéÆ Game Over</h2>
                <div style="margin: 20px 0;">
                    <div>Final Score: ${gameState.score}</div>
                    <div>Max Combo: ${gameState.maxCombo}x</div>
                    <div>Coins Earned: ${gameState.coins}</div>
                    <div>Diamonds Earned: ${gameState.diamonds}</div>
                </div>
                <button onclick="startGame('classic')">üîÑ Play Again</button>
                <button onclick="backToMenu()">üè† Main Menu</button>
            `;
            showCustomPopup(content);
        }

        function pauseGame() {
            gameState.isPaused = !gameState.isPaused;
            if (!gameState.isPaused) {
                startGameLoop();
            }
        }

        function backToMenu() {
            gameState.isPlaying = false;
            gameState.isPaused = false;
            
            document.getElementById('mainMenu').style.display = 'flex';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameUI').style.display = 'none';
            
            // Clean up split screen if it exists
            const splitScreen = document.getElementById('splitScreen');
            if (splitScreen) {
                splitScreen.remove();
            }
            
            hidePopup();
        }

        // Timer System
        function startTimer() {
            const timer = setInterval(() => {
                if (gameState.isPlaying && !gameState.isPaused) {
                    gameState.timeLeft--;
                    
                    if (gameState.timeLeft <= 0) {
                        clearInterval(timer);
                        endGame();
                    }
                    
                    // Update timer display
                    const timerDisplay = document.querySelector('.score-item:last-child');
                    if (timerDisplay) {
                        timerDisplay.innerHTML = `‚è±Ô∏è ${gameState.timeLeft}s`;
                    }
                }
            }, 1000);
        }

        // Popup System
        function showPopup(type) {
            const overlay = document.getElementById('popupOverlay');
            const content = document.getElementById('popupContent');
            
            overlay.style.display = 'flex';
            
            switch (type) {
                case 'missions':
                    content.innerHTML = getMissionsPopup();
                    break;
                case 'skills':
                    content.innerHTML = getSkillsPopup();
                    break;
                case 'shop':
                    content.innerHTML = getShopPopup();
                    break;
                case 'profile':
                    content.innerHTML = getProfilePopup();
                    break;
                case 'settings':
                    content.innerHTML = getSettingsPopup();
                    break;
                default:
                    content.innerHTML = '<h2>Coming Soon!</h2><button onclick="hidePopup()">Close</button>';
            }
        }

        function hidePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
        }

        function showPopupMessage(title, message, type = 'info') {
            const content = `
                <h2>${title}</h2>
                <p>${message}</p>
                <button onclick="hidePopup()">OK</button>
            `;
            showCustomPopup(content);
            
            if (type === 'success') {
                createConfetti();
            }
        }

        function showCustomPopup(content) {
            const overlay = document.getElementById('popupOverlay');
            const popupContent = document.getElementById('popupContent');
            overlay.style.display = 'flex';
            popupContent.innerHTML = content;
        }

        function getMissionsPopup() {
            let content = '<h2>üéØ Missions</h2>';
            
            content += '<h3>Daily Missions</h3>';
            gameData.dailyMissions.forEach(mission => {
                const progress = Math.min(mission.progress, mission.target);
                const percentage = (progress / mission.target) * 100;
                
                content += `
                    <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${mission.title}</strong>
                                <div style="font-size: 14px; opacity: 0.8;">${mission.description}</div>
                            </div>
                            ${mission.completed && !mission.claimed ? 
                                `<button onclick="claimMissionReward('${mission.id}', 'daily')" style="background: #FFD700; color: black;">Claim</button>` : 
                                mission.claimed ? '<span style="color: #90EE90;">‚úì Claimed</span>' : ''
                            }
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div style="font-size: 12px; margin-top: 5px;">${progress}/${mission.target}</div>
                    </div>
                `;
            });
            
            content += '<h3>Weekly Missions</h3>';
            gameData.weeklyMissions.forEach(mission => {
                const progress = Math.min(mission.progress, mission.target);
                const percentage = (progress / mission.target) * 100;
                
                content += `
                    <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${mission.title}</strong>
                                <div style="font-size: 14px; opacity: 0.8;">${mission.description}</div>
                            </div>
                            ${mission.completed && !mission.claimed ? 
                                `<button onclick="claimMissionReward('${mission.id}', 'weekly')" style="background: #FFD700; color: black;">Claim</button>` : 
                                mission.claimed ? '<span style="color: #90EE90;">‚úì Claimed</span>' : ''
                            }
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div style="font-size: 12px; margin-top: 5px;">${progress}/${mission.target}</div>
                    </div>
                `;
            });
            
            content += '<button onclick="hidePopup()">Close</button>';
            return content;
        }

        function claimMissionReward(missionId, type) {
            const missions = type === 'daily' ? gameData.dailyMissions : gameData.weeklyMissions;
            const mission = missions.find(m => m.id === missionId);
            
            if (mission && mission.completed && !mission.claimed) {
                mission.claimed = true;
                
                // Give rewards
                if (mission.reward.diamonds) {
                    gameState.diamonds += mission.reward.diamonds;
                }
                if (mission.reward.slowMotion) {
                    gameData.inventory.slowMotion += mission.reward.slowMotion;
                }
                
                updateDisplay();
                saveGameData();
                showPopupMessage('Reward Claimed!', 'Mission reward added to your inventory!', 'success');
                
                // Refresh the missions popup
                setTimeout(() => showPopup('missions'), 1000);
            }
        }

        function getSkillsPopup() {
            initializeSkills();
            
            let content = '<h2>üß¨ Skills Tree</h2>';
            content += '<div class="skills-tree">';
            
            Object.keys(gameData.skills).forEach(skillId => {
                const skill = gameData.skills[skillId];
                const cost = skill.cost * (skill.level + 1);
                const canUpgrade = skill.level < skill.maxLevel && gameState.coins >= cost;
                
                content += `
                    <div class="skill-node ${skill.level > 0 ? 'unlocked' : ''}" 
                         ${canUpgrade ? `onclick="upgradeSkill('${skillId}')"` : ''}>
                        <strong>${skillId.replace('_', ' ').toUpperCase()}</strong>
                        <div>Level: ${skill.level}/${skill.maxLevel}</div>
                        ${skill.level < skill.maxLevel ? 
                            `<div>Cost: ${cost} ü™ô</div>` : 
                            '<div style="color: #FFD700;">MAX LEVEL</div>'
                        }
                    </div>
                `;
            });
            
            content += '</div>';
            content += '<button onclick="hidePopup()">Close</button>';
            return content;
        }

        function getShopPopup() {
            let content = '<h2>üõí Shop</h2>';
            
            content += '<h3>Power-ups</h3>';
            const powerUps = [
                { id: 'slowMotion', name: 'Slow Motion', price: 50, emoji: 'üêå' },
                { id: 'doublePoints', name: 'Double Points', price: 75, emoji: '‚≠ê' },
                { id: 'shieldPower', name: 'Shield Power', price: 100, emoji: 'üõ°Ô∏è' },
                { id: 'fruitMagnet', name: 'Fruit Magnet', price: 60, emoji: 'üß≤' }
            ];
            
            powerUps.forEach(power => {
                const canBuy = gameState.coins >= power.price;
                content += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div>
                            <span style="font-size: 24px; margin-right: 10px;">${power.emoji}</span>
                            <strong>${power.name}</strong>
                        </div>
                        <div>
                            <span style="margin-right: 10px;">${power.price} ü™ô</span>
                            <button onclick="buyPowerUp('${power.id}', ${power.price})" 
                                    ${!canBuy ? 'disabled style="opacity: 0.5;"' : ''}>
                                Buy
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content += '<h3>Customizations</h3>';
            const customizations = [
                { id: 'fire_trail', name: 'Fire Trail', price: 200, type: 'trail' },
                { id: 'ice_trail', name: 'Ice Trail', price: 200, type: 'trail' },
                { id: 'rainbow_trail', name: 'Rainbow Trail', price: 300, type: 'trail' },
                { id: 'tropical_theme', name: 'Tropical Fruits', price: 500, type: 'theme' }
            ];
            
            customizations.forEach(item => {
                const canBuy = gameState.coins >= item.price;
                content += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <strong>${item.name}</strong>
                        <div>
                            <span style="margin-right: 10px;">${item.price} ü™ô</span>
                            <button onclick="buyCustomization('${item.id}', ${item.price}, '${item.type}')" 
                                    ${!canBuy ? 'disabled style="opacity: 0.5;"' : ''}>
                                Buy
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content += '<button onclick="hidePopup()">Close</button>';
            return content;
        }

        function buyPowerUp(powerId, price) {
            if (gameState.coins >= price) {
                gameState.coins -= price;
                gameData.inventory[powerId] = (gameData.inventory[powerId] || 0) + 1;
                updateDisplay();
                updatePowerUpDisplay();
                saveGameData();
                showPopupMessage('Purchase Successful!', `You bought a ${powerId}!`, 'success');
                
                // Refresh shop
                setTimeout(() => showPopup('shop'), 1000);
            }
        }

        function buyCustomization(itemId, price, type) {
            if (gameState.coins >= price) {
                gameState.coins -= price;
                
                if (type === 'trail') {
                    gameData.settings.slashTrail = itemId.replace('_trail', '');
                } else if (type === 'theme') {
                    gameData.settings.theme = itemId.replace('_theme', '');
                }
                
                updateDisplay();
                saveGameData();
                showPopupMessage('Purchase Successful!', `You bought ${itemId.replace('_', ' ')}!`, 'success');
                
                // Refresh shop
                setTimeout(() => showPopup('shop'), 1000);
            }
        }

        function getProfilePopup() {
            const achievements = Object.keys(gameData.achievements).length;
            const totalPlayTime = Math.floor((gameData.stats.totalPlayTime || 0) / 60000); // Convert to minutes
            
            let content = `
                <h2>üë§ Player Profile</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <div><strong>Username:</strong> ${gameData.username || 'Player'}</div>
                    <div><strong>Level:</strong> ${gameState.level}</div>
                    <div><strong>Total Score:</strong> ${gameData.totalScore}</div>
                    <div><strong>Total Coins:</strong> ${gameData.totalCoins}</div>
                    <div><strong>Total Diamonds:</strong> ${gameData.totalDiamonds}</div>
                    <div><strong>Games Played:</strong> ${gameData.stats.gamesPlayed}</div>
                    <div><strong>Fruits Sliced:</strong> ${gameData.stats.fruitsSliced}</div>
                    <div><strong>Perfect Combos:</strong> ${gameData.stats.perfectCombos}</div>
                    <div><strong>Achievements:</strong> ${achievements}</div>
                    <div><strong>Play Time:</strong> ${totalPlayTime} minutes</div>
                </div>
                
                <h3>üèÜ Achievements</h3>
                <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            const achievementsList = {
                first_slice: { title: 'First Slice', desc: 'Slice your first fruit', reward: '1üíé' },
                combo_master: { title: 'Combo Master', desc: 'Achieve 10x combo', reward: '5üíé' },
                hundred_fruits: { title: 'Fruit Ninja', desc: 'Slice 100 fruits', reward: '10üíé' }
            };
            
            Object.keys(achievementsList).forEach(achievementId => {
                const achievement = achievementsList[achievementId];
                const unlocked = gameData.achievements[achievementId];
                const claimed = unlocked && unlocked.claimed;
                
                content += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div>
                            <strong>${achievement.title}</strong>
                            <div style="font-size: 14px; opacity: 0.8;">${achievement.desc}</div>
                        </div>
                        <div>
                            ${unlocked ? 
                                (claimed ? 
                                    '<span style="color: #90EE90;">‚úì Claimed</span>' : 
                                    `<button onclick="claimAchievement('${achievementId}')" style="background: #FFD700; color: black;">Claim ${achievement.reward}</button>`
                                ) : 
                                '<span style="color: #888;">üîí Locked</span>'
                            }
                        </div>
                    </div>
                `;
            });
            
            content += `
                </div>
                <div style="margin: 20px 0;">
                    <input type="text" placeholder="Enter username" id="usernameInput" style="padding: 10px; margin-right: 10px; border-radius: 5px; border: none;">
                    <button onclick="updateUsername()">Update Username</button>
                </div>
                <button onclick="hidePopup()">Close</button>
            `;
            
            return content;
        }

        function updateUsername() {
            const input = document.getElementById('usernameInput');
            if (input.value.trim()) {
                gameData.username = input.value.trim();
                saveGameData();
                showPopupMessage('Username Updated!', `Welcome, ${gameData.username}!`, 'success');
            }
        }

        function getSettingsPopup() {
            let content = `
                <h2>‚öôÔ∏è Settings</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <label style="display: block; margin: 15px 0;">
                        <input type="checkbox" ${gameData.settings.sound ? 'checked' : ''} 
                               onchange="toggleSetting('sound')"> 
                        üîä Sound Effects
                    </label>
                    <label style="display: block; margin: 15px 0;">
                        <input type="checkbox" ${gameData.settings.music ? 'checked' : ''} 
                               onchange="toggleSetting('music')"> 
                        üéµ Background Music
                    </label>
                    <label style="display: block; margin: 15px 0;">
                        <input type="checkbox" ${gameData.settings.vibration ? 'checked' : ''} 
                               onchange="toggleSetting('vibration')"> 
                        üì≥ Vibration
                    </label>
                </div>
                
                <h3>üé® Current Theme</h3>
                <div>Slash Trail: ${gameData.settings.slashTrail || 'default'}</div>
                <div>Fruit Theme: ${gameData.settings.theme || 'classic'}</div>
                
                <div style="margin: 20px 0;">
                    <button onclick="exportSave()">üì§ Export Save</button>
                    <button onclick="importSave()">üì• Import Save</button>
                    <button onclick="resetGame()" style="background: #dc3545;">üóëÔ∏è Reset Game</button>
                </div>
                
                <button onclick="hidePopup()">Close</button>
            `;
            
            return content;
        }

        function toggleSetting(setting) {
            gameData.settings[setting] = !gameData.settings[setting];
            saveGameData();
        }

        function exportSave() {
            const saveData = JSON.stringify(gameData);
            const blob = new Blob([saveData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fruitslash_save.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSave() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            gameData = data;
                            saveGameData();
                            showPopupMessage('Import Successful!', 'Your save data has been loaded!', 'success');
                        } catch (error) {
                            showPopupMessage('Import Failed!', 'Invalid save file!', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                localStorage.removeItem('fruitSlashSave');
                location.reload();
            }
        }

        // Sound System
        function playSound(soundType) {
            if (!gameData.settings.sound) return;
            
            // Create audio context and play sounds
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const sounds = {
                slice: { frequency: 800, duration: 0.1 },
                bomb: { frequency: 200, duration: 0.3 },
                levelup: { frequency: 1000, duration: 0.5 },
                pet: { frequency: 600, duration: 0.2 }
            };
            
            const sound = sounds[soundType];
            if (!sound) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(sound.frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + sound.duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + sound.duration);
        }

        function playBackgroundMusic() {
            if (!gameData.settings.music) return;
            // Background music implementation would go here
        }

        // Visual Effects
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 10,
                    life: 60,
                    maxLife: 60,
                    emoji: ['üéâ', '‚ú®', '‚≠ê', 'üåü'][Math.floor(Math.random() * 4)],
                    size: 20 + Math.random() * 10
                });
            }
        }

        // Storage Functions
        function saveGameData() {
            // Update total stats
            gameData.totalScore = Math.max(gameData.totalScore, gameState.score);
            gameData.totalCoins += gameState.coins;
            gameData.totalDiamonds += gameState.diamonds;
            
            localStorage.setItem('fruitSlashSave', JSON.stringify(gameData));
        }

        function loadGameData() {
            const saved = localStorage.getItem('fruitSlashSave');
            if (saved) {
                try {
                    gameData = { ...gameData, ...JSON.parse(saved) };
                } catch (e) {
                    console.error('Failed to load save data:', e);
                }
            }
            
            // Initialize missing properties
            if (!gameData.settings) gameData.settings = { sound: true, music: true, vibration: true, theme: 'default' };
            if (!gameData.inventory) gameData.inventory = { slowMotion: 0, doublePoints: 0, shieldPower: 0, fruitMagnet: 0 };
            if (!gameData.achievements) gameData.achievements = {};
            if (!gameData.stats) gameData.stats = { gamesPlayed: 0, fruitsSliced: 0, bombsHit: 0, perfectCombos: 0, totalPlayTime: 0 };
            if (!gameData.vault) gameData.vault = { coins: 0, lastInterest: Date.now() };
            
            // Load current game state
            gameState.coins = gameData.totalCoins;
            gameState.diamonds = gameData.totalDiamonds;
            
            updateDisplay();
            updatePowerUpDisplay();
            checkDailyBonus();
        }

        // PWA Functions
        function setupPWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCJpbnN0YWxsIiwgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbChjYWNoZXMub3BlbigiZnJ1aXRzbGFzaC12MSIpLnRoZW4oY2FjaGUgPT4gewogICAgcmV0dXJuIGNhY2hlLmFkZEFsbChbIi8iXSk7CiAgfSkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcigiZmV0Y2giLCBldmVudCA9PiB7CiAgZXZlbnQucmVzcG9uZFdpdGgoY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgcmV0dXJuIHJlc3BvbnNlIHx8IGZldGNoKGV2ZW50LnJlcXVlc3QpOwogIH0pKTsKfSk7')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
            }
            
            // Handle install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
            });
            
            window.installApp = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        deferredPrompt = null;
                        document.getElementById('installPrompt').style.display = 'none';
                    });
                }
            };
        }

        function checkInstallPrompt() {
            const sessions = parseInt(localStorage.getItem('fruitSlashSessions') || '0');
            localStorage.setItem('fruitSlashSessions', sessions + 1);
            
            if (sessions >= 2 && !window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('installPrompt').style.display = 'block';
            }
        }

        // Utility Functions
        function checkGameEnd() {
            if (gameState.lives <= 0) {
                endGame();
            }
            
            if (gameState.mode === 'timed' && gameState.timeLeft <= 0) {
                endGame();
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initGame);
        
        // Handle page visibility for auto-save
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                saveGameData();
            }
        });
        
        // Handle beforeunload for auto-save
        window.addEventListener('beforeunload', saveGameData);
    </script>
</body>
</html>
